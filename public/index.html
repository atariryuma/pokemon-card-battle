<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</title>
    <!-- Tailwind: load via CDN only in development (suppress CDN warning) -->
    <script>
        (function () {
            const host = (location.hostname || '').toLowerCase();
            const isDevHost = ['localhost', '127.0.0.1', '0.0.0.0'].includes(host) || host.endsWith('.local');
            const isDev = location.protocol === 'file:' || isDevHost || /[?&]dev(=1)?\b/.test(location.search);

            if (isDev) {
                const __origWarn = console.warn;
                console.warn = function (...args) {
                    const msg = String(args?.[0] ?? '');
                    if (msg.includes('cdn.tailwindcss.com should not be used in production')) {
                        // Ignore Tailwind CDN production warning in development
                        return;
                    }
                    return __origWarn.apply(console, args);
                };

                const s = document.createElement('script');
                s.src = 'https://cdn.tailwindcss.com';
                s.onload = () => {
                    // Restore original warn after Tailwind initializes
                    console.warn = __origWarn;
                    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ãƒ­ã‚°å‡ºåŠ›
                    if (window.location.search.includes('debug=true')) {
                        console.info('âœ… Tailwind CSS development environment ready');
                    }
                };
                document.head.appendChild(s);
            } else {
                // In production, Tailwind should be built via CLI/PostCSS.
                console.info('â„¹ï¸ Tailwind CDN not loaded (production). Use a built CSS file.');
            }
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Three.js ES Module Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
                "three/": "https://cdn.jsdelivr.net/npm/three@0.169.0/"
            }
        }
    </script>

    <!-- æ–°ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼CSSã‚·ã‚¹ãƒ†ãƒ  -->
    <link rel="stylesheet" href="../src/styles/main.css">
</head>

<body class="min-h-screen text-white">
    <!-- Three.js 3D Canvas Layer (Global Background) -->
    <div id="three-container"></div>

    <div class="game-wrapper">

        <div id="game-stage" class="game-stage w-full flex flex-col items-center"
            style="gap: calc(var(--vertical-gap)/2);">

            <div id="game-board">
                <img class="board-bg" src="assets/playmat/playmat.jpg" alt="Playmat"
                    onerror="this.style.display='none'" />

                <!-- ç›¸æ‰‹ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <div id="cpu-board" class="player-board opponent-board">
                    <!-- Active Pokemon -->
                    <div class="card-slot active-top" data-zone="Active" data-orientation="flipped"></div>


                    <!-- Bench Row (5 slots) -->
                    <div class="card-slot top-bench-1" data-zone="Bench" data-orientation="flipped"></div>
                    <div class="card-slot top-bench-2" data-zone="Bench" data-orientation="flipped"></div>
                    <div class="card-slot top-bench-3" data-zone="Bench" data-orientation="flipped"></div>
                    <div class="card-slot top-bench-4" data-zone="Bench" data-orientation="flipped"></div>
                    <div class="card-slot top-bench-5" data-zone="Bench" data-orientation="flipped"></div>

                    <!-- Side Cards (6 cards in 3 stacks) -->
                    <div class="side-cards-container side-right">
                        <div class="prize-stack prize-stack-1">
                            <div class="card-slot side-right-1" data-zone="Prize" data-prize-index="0"
                                data-orientation="flipped"></div>
                            <div class="card-slot side-right-1-back" data-zone="Prize" data-prize-index="1"
                                data-orientation="flipped"></div>
                        </div>
                        <div class="prize-stack prize-stack-2">
                            <div class="card-slot side-right-2" data-zone="Prize" data-prize-index="2"
                                data-orientation="flipped"></div>
                            <div class="card-slot side-right-2-back" data-zone="Prize" data-prize-index="3"
                                data-orientation="flipped"></div>
                        </div>
                        <div class="prize-stack prize-stack-3">
                            <div class="card-slot side-right-3" data-zone="Prize" data-prize-index="4"
                                data-orientation="flipped"></div>
                            <div class="card-slot side-right-3-back" data-zone="Prize" data-prize-index="5"
                                data-orientation="flipped"></div>
                        </div>
                    </div>

                    <!-- Deck and Discard (these stay upright) -->
                    <div class="card-slot deck-container top-left-deck" data-zone="Deck" data-orientation="upright">
                        <div class="deck-stack"></div>
                    </div>
                    <div class="card-slot top-left-trash" data-zone="Trash" data-orientation="upright"></div>
                </div>

                <!-- Stadium Zone (Shared) -->
                <div class="card-slot stadium-zone" data-zone="Stadium" data-orientation="upright"></div>

                <!-- è‡ªåˆ†ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                <div class="player-board player-self">
                    <!-- Active Pokemon -->
                    <div class="card-slot active-bottom" data-zone="Active" data-orientation="upright"></div>

                    <!-- Bench Row (5 slots) -->
                    <div class="card-slot bottom-bench-1" data-zone="Bench" data-orientation="upright"></div>
                    <div class="card-slot bottom-bench-2" data-zone="Bench" data-orientation="upright"></div>
                    <div class="card-slot bottom-bench-3" data-zone="Bench" data-orientation="upright"></div>
                    <div class="card-slot bottom-bench-4" data-zone="Bench" data-orientation="upright"></div>
                    <div class="card-slot bottom-bench-5" data-zone="Bench" data-orientation="upright"></div>

                    <!-- Side Cards (6 cards in 3 stacks) -->
                    <div class="side-cards-container side-left">
                        <div class="prize-stack prize-stack-1">
                            <div class="card-slot side-left-1" data-zone="Prize" data-prize-index="0"
                                data-orientation="upright"></div>
                            <div class="card-slot side-left-1-back" data-zone="Prize" data-prize-index="1"
                                data-orientation="upright"></div>
                        </div>
                        <div class="prize-stack prize-stack-2">
                            <div class="card-slot side-left-2" data-zone="Prize" data-prize-index="2"
                                data-orientation="upright"></div>
                            <div class="card-slot side-left-2-back" data-zone="Prize" data-prize-index="3"
                                data-orientation="upright"></div>
                        </div>
                        <div class="prize-stack prize-stack-3">
                            <div class="card-slot side-left-3" data-zone="Prize" data-prize-index="4"
                                data-orientation="upright"></div>
                            <div class="card-slot side-left-3-back" data-zone="Prize" data-prize-index="5"
                                data-orientation="upright"></div>
                        </div>
                    </div>

                    <!-- Deck and Discard -->
                    <div class="card-slot deck-container bottom-right-deck" data-zone="Deck" data-orientation="upright">
                        <div class="deck-stack"></div>
                    </div>
                    <div class="card-slot bottom-right-trash" data-zone="Trash" data-orientation="upright"></div>
                </div>
            </div>
        </div>

        <!-- CPU Hand Container (Independent) -->
        <div id="cpu-hand-area-new" class="cpu-hand-independent">
            <div class="cpu-hand-container">
                <div id="cpu-hand" class="cpu-hand-scaling" data-owner="cpu" data-zone="hand">
                    <!-- CPUæ‰‹æœ­ã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>

        <!-- Player Hand Container -->
        <div id="player-hand-container">
            <div id="player-hand" class="hand-dock">
                <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ã¯ã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
        </div>

        <!-- Game Footer with HUD -->
        <div class="game-footer">
            <div id="floating-action-hud" class="w-full flex flex-wrap gap-3 justify-center">
                <button type="button" id="start-game-button-float" class="pokemon-action-btn">
                    <span class="pokemon-btn-icon">ğŸ´</span>
                    <span class="pokemon-btn-text">æ‰‹æœ­ã‚’7æšå¼•ã</span>
                </button>
                <button type="button" id="card-editor-button-float" class="pokemon-action-btn">
                    <span class="pokemon-btn-icon">ğŸ´</span>
                    <span class="pokemon-btn-text">ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿</span>
                </button>
                <button type="button" id="confirm-setup-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">âœ…</span>
                    <span class="pokemon-btn-text">ãƒã‚±ãƒ¢ãƒ³é…ç½®ã‚’ç¢ºå®š</span>
                </button>
                <button type="button" id="retreat-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">ğŸƒ</span>
                    <span class="pokemon-btn-text">ã«ã’ã‚‹</span>
                </button>
                <button type="button" id="attack-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">âš”ï¸</span>
                    <span class="pokemon-btn-text">æ”»æ’ƒ</span>
                </button>
                <button type="button" id="evolve-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">ğŸ”„</span>
                    <span class="pokemon-btn-text">é€²åŒ–</span>
                </button>
                <button type="button" id="end-turn-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">âœ…</span>
                    <span class="pokemon-btn-text">ã‚¿ãƒ¼ãƒ³çµ‚äº†</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Game Status Panel (ã‚°ãƒªãƒƒãƒ‰å¤–ã®å›ºå®šä½ç½®) -->
    <div id="game-status-panel" class="">
        <div class="status-panel-content">
            <!-- Header Section -->
            <div class="status-panel-header">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-lg font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">ã‚²ãƒ¼ãƒ çŠ¶æ³
                    </div>
                    <div class="text-sm text-yellow-300">
                        <span id="turn-player" class="font-semibold"
                            style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">YOU</span>
                    </div>
                </div>
                <div class="text-xs text-white" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">
                    <span id="phase-indicator">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</span> â€¢ ã‚¿ãƒ¼ãƒ³ <span id="turn-indicator">1</span>
                </div>
            </div>

            <!-- Body Section -->
            <div class="status-panel-body">
                <!-- Progress Indicators (ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã®ã¿è¡¨ç¤º) -->
                <div id="setup-progress" class="status-info-section">
                    <div class="status-info-title">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²è¡Œ</div>
                    <div class="flex items-center space-x-4 text-xs mt-2">
                        <div class="flex items-center">
                            <div id="active-status" class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                            <span class="text-gray-300">ãƒãƒˆãƒ«å ´</span>
                        </div>
                        <div class="flex items-center">
                            <div id="bench-status" class="w-2 h-2 rounded-full bg-gray-500 mr-2"></div>
                            <span class="text-gray-300">ãƒ™ãƒ³ãƒ (<span id="bench-count">0</span>/5)</span>
                        </div>
                    </div>
                </div>

                <!-- Prize Cards Status -->
                <div id="prize-status" class="status-info-section">
                    <div class="status-info-title">ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰</div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-sm text-blue-200">YOU</span>
                            <span id="player-prize-count" class="font-bold text-white">6/6</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-sm text-red-200">CPU</span>
                            <span id="cpu-prize-count" class="font-bold text-white">6/6</span>
                        </div>
                    </div>
                </div>

                <!-- Current Message Area -->
                <div class="status-info-section">
                    <div class="status-info-title">ç¾åœ¨ã®çŠ¶æ³</div>
                    <div class="game-message-area">
                        <div id="game-message-display" class="game-message-text">
                            ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- Card Info Panel -->
    <div id="card-info-panel" class="hidden fixed"></div>



    <script>
        // Expose noop globally so modules can reuse it without errors
        // GitHub Pagesç’°å¢ƒã§ã¯é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®ãŸã‚ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ€å°åŒ–
        window.noop = console.log ? console.log.bind(console) : () => { };

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼šä¸è¦ãªãƒ­ã‚°ã‚’åˆ¶é™
        if (window.location.hostname.includes('github.io')) {
            console.log = () => { };
            console.debug = () => { };
            window.noop = () => { };
        }
        document.addEventListener('DOMContentLoaded', async () => {
            // æ‰‹æœ­ã‚«ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ã¨ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
            function setupHandCardInteraction() {
                const handContainer = document.getElementById('player-hand-container');
                const handSlots = document.querySelectorAll('#player-hand .hand-slot');

                // æ‰‹æœ­ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
                handSlots.forEach(slot => {
                    slot.addEventListener('click', (e) => {
                        e.stopPropagation();
                        // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’è§£é™¤
                        handSlots.forEach(s => s.classList.remove('active'));
                        // ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                        slot.classList.add('active');
                    });
                });

                // ã‚³ãƒ³ãƒ†ãƒŠç©ºç™½éƒ¨åˆ†ã®ã‚¯ãƒªãƒƒã‚¯é€éå‡¦ç†
                handContainer.addEventListener('click', (e) => {
                    // ç©ºç™½éƒ¨åˆ†ã®ã‚¯ãƒªãƒƒã‚¯ã¯ä¸‹ã®è¦ç´ ã«é€é
                    if (e.target === handContainer || e.target.id === 'player-hand') {
                        const elementBelow = document.elementFromPoint(e.clientX, e.clientY - 1);
                        if (elementBelow && elementBelow !== handContainer) {
                            elementBelow.click();
                        }
                    }
                });
            }

            const gameBoard = document.getElementById('game-board');
            const bgImage = document.querySelector('.board-bg');
            const playerBoards = {
                self: document.querySelector('.player-board.player-self'),
                opponent: document.querySelector('.player-board.opponent-board')
            };

            // JSONã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒãƒƒãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿
            let data = null;
            try {
                const res = await fetch('./assets/playmat/playmat_slots_named.json');
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                data = await res.json();
                window.playmatSlotsData = data; // Make it globally accessible
                console.log('âœ… Playmat slot data loaded successfully');
            } catch (e) {
                console.error('âŒ Failed to load playmat slot data:', e);
                console.warn('âš ï¸ Using fallback layout without slot positioning');
                return; // GitHub Pagesç’°å¢ƒã§ã®å‹•ä½œã‚’ç¶™ç¶š
            }
            if (!data) {
                console.warn('âš ï¸ No playmat data available, using default layout');
                return;
            }

            const imgSize = data.image_size || { width: 679, height: 679 };
            const cardSize = (data.card_median_size) || { width: 74, height: 103 };
            const named = Array.isArray(data.slots_named) ? data.slots_named : [];

            const find = (name) => named.find(s => s.name === name);
            const rectFrom = (slot) => ({ x: slot.bbox.x_min, y: slot.bbox.y_min, width: slot.size.width, height: slot.size.height });

            const coordsSelf = {};
            const coordsOpp = {};
            const coordsShared = {};

            // Bench slots (exact coordinates from playmat)
            for (let i = 1; i <= 5; i++) {
                const bottomBench = find(`bottom_bench_${i}`);
                const topBench = find(`top_bench_${i}`);
                if (bottomBench) coordsSelf[`bottom-bench-${i}`] = rectFrom(bottomBench);
                if (topBench) coordsOpp[`top-bench-${i}`] = rectFrom(topBench);
            }

            // Active pokemon areas (exact coordinates)
            const activeBottom = find('active_bottom');
            const activeTop = find('active_top');
            if (activeBottom) coordsSelf['active-bottom'] = rectFrom(activeBottom);
            if (activeTop) coordsOpp['active-top'] = rectFrom(activeTop);

            // Side cards (exact coordinates for 3 slots each)
            for (let i = 1; i <= 3; i++) {
                const leftSide = find(`side_left_${i}`);
                const rightSide = find(`side_right_${i}`);
                if (leftSide) coordsSelf[`side-left-${i}`] = rectFrom(leftSide);
                if (rightSide) coordsOpp[`side-right-${i}`] = rectFrom(rightSide);
            }

            // Deck and discard areas (exact coordinates)
            const bottomRightDeck = find('bottom_right_deck');
            const bottomRightTrash = find('bottom_right_trash');
            const topLeftDeck = find('top_left_deck');
            const topLeftTrash = find('top_left_trash');
            if (bottomRightDeck) coordsSelf['bottom-right-deck'] = rectFrom(bottomRightDeck);
            if (bottomRightTrash) coordsSelf['bottom-right-trash'] = rectFrom(bottomRightTrash);
            if (topLeftDeck) coordsOpp['top-left-deck'] = rectFrom(topLeftDeck);
            if (topLeftTrash) coordsOpp['top-left-trash'] = rectFrom(topLeftTrash);

            // Stadium (shared zone)
            const stadium = find('stadium');
            if (stadium) coordsShared['stadium-zone'] = rectFrom(stadium);

            function buildCoordsCSS(map, scopeSelector) {
                if (!map) return '';
                const DEBUG_MODE = true;
                const PLAYMAT_WIDTH = (imgSize && imgSize.width) ? imgSize.width : 679;
                const PLAYMAT_HEIGHT = (imgSize && imgSize.height) ? imgSize.height : 679;
                const transformedCoords = [];
                let css = '';
                for (const [key, coords] of Object.entries(map)) {
                    const leftPct = (coords.x / PLAYMAT_WIDTH) * 100;
                    const topPct = (coords.y / PLAYMAT_HEIGHT) * 100;
                    const widthPct = (coords.width / PLAYMAT_WIDTH) * 100;
                    const heightPct = (coords.height / PLAYMAT_HEIGHT) * 100;
                    if (coords.width < 10 || coords.height < 10) {
                        console.warn(`âš ï¸ Suspiciously small size for ${key}: ${coords.width.toFixed(1)}x${coords.height.toFixed(1)}`);
                    }
                    transformedCoords.push({ key, leftPct, topPct, widthPct, heightPct });
                    // Determine z-index based on scope
                    const zIndex = scopeSelector.includes('player-self') ? 'var(--z-board)' :
                        scopeSelector.includes('opponent-board') ? 'var(--z-board)' :
                            'var(--z-placeholder)';
                    css += `${scopeSelector} .${key}{position:absolute!important;left:${leftPct}%;top:${topPct}%;width:${widthPct}%;height:${heightPct}%;display:block!important;opacity:1!important;pointer-events:auto!important;cursor:pointer!important;z-index:${zIndex}!important;}
`;
                    if (key.startsWith('side-left-') || key.startsWith('side-right-')) {
                        const dxPx = key.startsWith('side-left-') ? -4 : 4;
                        const dyPx = 3;
                        const dxPct = (dxPx / PLAYMAT_WIDTH) * 100;
                        const dyPct = (dyPx / PLAYMAT_HEIGHT) * 100;
                        css += `${scopeSelector} .${key}-back{position:absolute!important;left:${leftPct + dxPct}%;top:${topPct + dyPct}%;width:${widthPct}%;height:${heightPct}%;display:block!important;opacity:1!important;pointer-events:auto!important;cursor:pointer!important;z-index:${zIndex}!important;}
`;
                    }
                    if (DEBUG_MODE && (key.includes('bottom-bench') || key.includes('active-bottom'))) {
                        // åº§æ¨™æƒ…å ±ã¯ãƒ‡ãƒãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ ã§å‡ºåŠ›
                    }
                }
                // å¤‰æ›æƒ…å ±ã¯ãƒ‡ãƒãƒƒã‚°ã‚·ã‚¹ãƒ†ãƒ ã§å‡ºåŠ›
                return css;
            }

            function updateDeckHeight(deckElement, cardCount) {
                if (!deckElement) return;
                const stack = deckElement.querySelector('.deck-stack');
                if (!stack) return;

                // Calculate height based on card count (max 60 cards, max 20px height)
                const maxHeight = 20;
                const height = Math.min(maxHeight, Math.max(2, cardCount * 0.3));

                // Update the pseudo-elements for stacking effect
                const before = stack.style;
                before.setProperty('--deck-height', `${height}px`);
            }

            function updateLayout() {
                // CSSæ–‡å­—åˆ—ã‚’ç”Ÿæˆã—ã¦ã‚¹ã‚¿ã‚¤ãƒ«ã‚¿ã‚°ã«é©ç”¨ï¼ˆå®Œå…¨CSSç®¡ç†ï¼‰
                // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³styleã®transformç³»ã®ã¿é™¤å»ï¼ˆpointer-eventsã¯ç¶­æŒï¼‰
                const allSlots = document.querySelectorAll('#game-board .card-slot');
                allSlots.forEach(el => {
                    // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦CSSã«åˆ¶å¾¡ã‚’ä»»ã›ã‚‹
                    el.style.removeProperty('transform');
                    el.style.removeProperty('left');
                    el.style.removeProperty('top');
                    el.style.removeProperty('width');
                    el.style.removeProperty('height');
                    // pointer-events, z-indexç­‰ã¯ä¿æŒã—ã¦ã‚¯ãƒªãƒƒã‚¯æ©Ÿèƒ½ã‚’ç¶­æŒ
                });

                let css = '';
                css += buildCoordsCSS(coordsSelf, '#game-board .player-board.player-self') || '';
                css += buildCoordsCSS(coordsOpp, '#game-board .player-board.opponent-board') || '';
                css += buildCoordsCSS(coordsShared, '#game-board') || '';
                let styleTag = document.getElementById('slot-style-generated');
                if (!styleTag) {
                    styleTag = document.createElement('style');
                    styleTag.id = 'slot-style-generated';
                    document.head.appendChild(styleTag);
                }
                styleTag.textContent = css;

                // æ³¨: ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã® data-orientation ã¯ HTML ã«ç›´æ¥è¨­å®šæ¸ˆã¿
                // å‹•çš„ã«é…ç½®ã•ã‚Œã‚‹ã‚«ãƒ¼ãƒ‰ã®ã¿ CardOrientationManager ã§è¨­å®šã™ã‚‹

                // æ‰‹æœ­ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­å®š
                setupHandCardInteraction();

                // ãƒ‡ãƒƒã‚­é«˜ã•æ›´æ–°å‡¦ç†ï¼ˆã‚²ãƒ¼ãƒ çŠ¶æ…‹é€£æºæ™‚ã«å®Ÿè£…ï¼‰
                const playerDeck = playerBoards.self?.querySelector('.deck-container');
                const opponentDeck = playerBoards.opponent?.querySelector('.deck-container');
                if (typeof updateDeckHeight === 'function') {
                    updateDeckHeight(playerDeck, 40);
                    updateDeckHeight(opponentDeck, 35);
                }

                // Debug instrumentation removed
            }

            // åˆæœŸåŒ–å‡¦ç†ï¼šèƒŒæ™¯ç”»åƒã¨DOMã®æº–å‚™å®Œäº†ã‚’å¾…ã¤
            function initializeLayout() {
                // ãƒ—ãƒ¬ã‚¤ãƒãƒƒãƒˆåˆæœŸåŒ–

                // RequestAnimationFrameã§æ¬¡ã®æç”»ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’å¾…ã¤ï¼ˆãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰
                requestAnimationFrame(() => {
                    updateLayout();
                    // ãƒ—ãƒ¬ã‚¤ãƒãƒƒãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆæœŸåŒ–å®Œäº†
                });
            }

            // èƒŒæ™¯ç”»åƒã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé–‹å§‹
            if (bgImage) {
                if (bgImage.complete && bgImage.naturalHeight > 0) {
                    // ç”»åƒãŒæ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿
                    // ãƒ—ãƒ¬ã‚¤ãƒãƒƒãƒˆç”»åƒèª­ã¿è¾¼ã¿æ¸ˆã¿
                    initializeLayout();
                } else {
                    // ç”»åƒã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤
                    noop('â³ Waiting for playmat image to load...');
                    bgImage.addEventListener('load', () => {
                        noop('ğŸ“¸ Playmat image loaded successfully');
                        initializeLayout();
                    }, { once: true });

                    bgImage.addEventListener('error', () => {
                        console.error('âŒ Failed to load playmat image');
                        initializeLayout(); // ç”»åƒãªã—ã§ã‚‚é…ç½®ã¯å®Ÿè¡Œ
                    }, { once: true });
                }
            } else {
                console.warn('âš ï¸ Background image element not found');
                initializeLayout();
            }

            // ãƒªã‚µã‚¤ã‚ºæ™‚ã®å‡¦ç†ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    noop('ğŸ”„ Window resized, updating layout...');
                    updateLayout();
                }, 100);
            });

            // ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            const cardEditorButton = document.getElementById('card-editor-button-float');
            if (cardEditorButton) {
                cardEditorButton.addEventListener('click', () => {
                    window.location.href = 'card_viewer.html';
                });
            }

            // 3Dè¨­å®šã¯Three.js (scene.js) ã§ç®¡ç†ã€CSSå¤‰æ•°ã¯ä¸è¦
        });

        // ================= Debug helpers =================
        /* Debug helpers removed */
        function getStyles(el) {
            const cs = window.getComputedStyle(el);
            return {
                position: cs.position,
                left: cs.left,
                top: cs.top,
                width: cs.width,
                height: cs.height,
                zIndex: cs.zIndex,
                display: cs.display,
                visibility: cs.visibility,
                opacity: cs.opacity,
                pointerEvents: cs.pointerEvents,
                transform: cs.transform,
                transformStyle: cs.transformStyle,
                willChange: cs.willChange
            };
        }
        // Debug helpers removed
    </script>
    <!-- Action Modal -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center"
        style="z-index: var(--z-modals);"></div>

    <script type="module">
        // Modal Manager ã®åˆæœŸåŒ–
        try {
            const { modalManager } = await import('/src/js/modal-manager.js');
            const noop = window.noop || (() => { });

            // DOMæº–å‚™å®Œäº†å¾Œã«Modal Managerã‚’åˆæœŸåŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    modalManager.init();
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
                });
            } else {
                modalManager.init();
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
            }
        } catch (e) {
            console.warn('âš ï¸ Modal Manager module not available:', e.message);
        }
    </script>
    <script type="module">
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
        // main.jsã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹

        try {
            const module = await import('/src/js/main.js');
            // main.jsã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ

            // åˆæœŸåŒ–å®Œäº†ã‚’å¾…æ©Ÿ
            if (!window.game) {
                console.log('â³ HTML: Waiting for game initialization...');
                window.addEventListener('gameInitialized', (event) => {
                    const { success, game, error } = event.detail;
                    if (success) {
                        console.log('ğŸ‰ HTML: Game initialized successfully!');
                    } else {
                        console.error('ğŸ’¥ HTML: Game initialization failed:', error);
                        showInitializationError(error);
                    }
                });
            }

        } catch (e) {
            console.error('âŒ HTML: Failed to import main.js:', e);
            showInitializationError(e);
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½
        function showInitializationError(error) {
            console.log('ğŸš¨ HTML: Showing initialization error to user');

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            const errorModal = document.createElement('div');
            errorModal.id = 'initialization-error-modal';
            errorModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: var(--z-critical);
                font-family: system-ui, sans-serif;
            `;

            errorModal.innerHTML = `
                <div style="
                    background: #1a1a1a;
                    color: #fff;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 500px;
                    text-align: center;
                    border: 2px solid #ff6b6b;
                ">
                    <h2 style="color: #ff6b6b; margin-bottom: 15px;">âš ï¸ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2>
                    <p style="margin-bottom: 20px; line-height: 1.5;">
                        ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>
                        ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <details style="text-align: left; margin-bottom: 20px; font-size: 12px;">
                        <summary style="cursor: pointer; color: #ccc;">è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±</summary>
                        <pre style="
                            background: #333;
                            padding: 10px;
                            border-radius: 5px;
                            overflow: auto;
                            margin-top: 10px;
                            white-space: pre-wrap;
                        ">${error.message || error}</pre>
                    </details>
                    <button onclick="location.reload()" style="
                        background: #4caf50;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        margin-right: 10px;
                    ">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: #666;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                    ">é–‰ã˜ã‚‹</button>
                </div>
            `;

            document.body.appendChild(errorModal);
        }
    </script>
</body>

</html>