<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ãƒãƒˆãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰</title>
    <!-- Tailwind: load via CDN only in development (suppress CDN warning) -->
    <script>
        (function () {
            const host = (location.hostname || '').toLowerCase();
            const isDevHost = ['localhost', '127.0.0.1', '0.0.0.0'].includes(host) || host.endsWith('.local');
            const isDev = location.protocol === 'file:' || isDevHost || /[?&]dev(=1)?\b/.test(location.search);

            if (isDev) {
                const __origWarn = console.warn;
                console.warn = function (...args) {
                    const msg = String(args?.[0] ?? '');
                    if (msg.includes('cdn.tailwindcss.com should not be used in production')) {
                        // Ignore Tailwind CDN production warning in development
                        return;
                    }
                    return __origWarn.apply(console, args);
                };

                const s = document.createElement('script');
                s.src = 'https://cdn.tailwindcss.com';
                s.onload = () => {
                    // Restore original warn after Tailwind initializes
                    console.warn = __origWarn;
                    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã§ã®ã¿ãƒ­ã‚°å‡ºåŠ›
                    if (window.location.search.includes('debug=true')) {
                        console.info('âœ… Tailwind CSS development environment ready');
                    }
                };
                document.head.appendChild(s);
            } else {
                // In production, Tailwind should be built via CLI/PostCSS.
                console.info('â„¹ï¸ Tailwind CDN not loaded (production). Use a built CSS file.');
            }
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;700&display=swap"
        rel="stylesheet">

    <!-- Three.js ES Module Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
                "three/": "https://cdn.jsdelivr.net/npm/three@0.169.0/",
                "gsap": "https://cdn.jsdelivr.net/npm/gsap@3.12.5/+esm"
            }
        }
    </script>

    <!-- æ–°ãƒ¢ã‚¸ãƒ¥ãƒ©ãƒ¼CSSã‚·ã‚¹ãƒ†ãƒ  -->
    <link rel="stylesheet" href="../src/styles/main.css">
</head>

<body class="min-h-screen text-white">
    <!-- Three.js 3D Canvas Layer (Global Background) -->
    <div id="three-container"></div>

    <!-- âœ… Game Over Overlay -->
    <div id="game-over-overlay" class="hidden">
        <div class="game-over-content">
            <h1 id="game-result-title" class="result-title">VICTORY</h1>
            <div id="game-result-reason" class="result-reason">Opponent ran out of prize cards!</div>
            <button id="play-again-btn" class="start-btn start-btn-primary">
                Play Again
            </button>
        </div>
    </div>

    <!-- âœ… Start Screen Overlay (Glassmorphism) -->
    <div id="start-screen">
        <div class="start-logo-container">
            <div class="start-logo-text">POKÃ‰MON</div>
            <div class="start-logo-sub">TRADING CARD GAME 3D EXPERIMENT</div>
        </div>

        <div class="start-menu-container">
            <button id="start-btn-primary" class="start-btn start-btn-primary">
                Game Start
            </button>
            <!-- Future buttons: Deck Builder, Settings -->
        </div>

        <div class="start-footer">
            <p>Developer Preview v0.9.5 | Three.js WebGL</p>
        </div>
    </div>

    <!-- Game Wrapper (Initially Hidden) -->
    <div id="game-wrapper" class="game-wrapper hidden">

        <!-- âœ… Three.jså°‚ç”¨: DOMç‰ˆã‚²ãƒ¼ãƒ ãƒœãƒ¼ãƒ‰ã¯å‰Šé™¤ -->
        <div id="game-stage" class="game-stage w-full flex flex-col items-center"
            style="gap: calc(var(--vertical-gap)/2);">
            <!-- Three.jsãŒ#three-containerã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° -->
        </div>

        <!-- âœ… ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰æ–¹å¼: æ‰‹æœ­ã¯DOM/CSSç‰ˆï¼ˆæ¨™æº–çš„ãªTCGæ–¹å¼ï¼‰ã€ãƒœãƒ¼ãƒ‰ã¯3D -->
        <!-- CPU Hand (top) -->
        <div id="cpu-hand-container" class="hand-container cpu-hand-container">
            <!-- CPU hand cards rendered here -->
        </div>

        <!-- Player Hand (bottom) -->
        <div id="player-hand-container" class="hand-container player-hand-container">
            <!-- Player hand cards rendered here -->
        </div>

        <!-- Game Footer with HUD -->
        <div class="game-footer">
            <div id="floating-action-hud" class="w-full flex flex-wrap gap-3 justify-center">
                <button type="button" id="start-game-button-float" class="pokemon-action-btn">
                    <span class="pokemon-btn-icon">ğŸ´</span>
                    <span class="pokemon-btn-text">æ‰‹æœ­ã‚’7æšå¼•ã</span>
                </button>
                <button type="button" id="card-editor-button-float" class="pokemon-action-btn">
                    <span class="pokemon-btn-icon">ğŸ´</span>
                    <span class="pokemon-btn-text">ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿</span>
                </button>
                <button type="button" id="confirm-setup-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">âœ…</span>
                    <span class="pokemon-btn-text">ãƒã‚±ãƒ¢ãƒ³é…ç½®ã‚’ç¢ºå®š</span>
                </button>
                <button type="button" id="retreat-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">ğŸƒ</span>
                    <span class="pokemon-btn-text">ã«ã’ã‚‹</span>
                </button>
                <button type="button" id="attack-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">âš”ï¸</span>
                    <span class="pokemon-btn-text">æ”»æ’ƒ</span>
                </button>
                <button type="button" id="evolve-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">ğŸ”„</span>
                    <span class="pokemon-btn-text">é€²åŒ–</span>
                </button>
                <button type="button" id="end-turn-button-float" class="pokemon-action-btn hidden">
                    <span class="pokemon-btn-icon">âœ…</span>
                    <span class="pokemon-btn-text">ã‚¿ãƒ¼ãƒ³çµ‚äº†</span>
                </button>
            </div>
        </div>
    </div><!-- End of game-wrapper -->

    <!-- Game Status Panel (ã‚°ãƒªãƒƒãƒ‰å¤–ã®å›ºå®šä½ç½® - Initially Hidden) -->
    <div id="game-status-panel" class="hidden">
        <div class="status-panel-content">
            <!-- Header Section -->
            <div class="status-panel-header">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-lg font-bold text-white" style="text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">ã‚²ãƒ¼ãƒ çŠ¶æ³
                    </div>
                    <div class="text-sm text-yellow-300">
                        <span id="turn-player" class="font-semibold"
                            style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">YOU</span>
                    </div>
                </div>
                <div class="text-xs text-white" style="text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);">
                    <span id="phase-indicator">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—</span> â€¢ ã‚¿ãƒ¼ãƒ³ <span id="turn-indicator">1</span>
                </div>
            </div>

            <!-- Body Section -->
            <div class="status-panel-body">
                <!-- Progress Indicators (ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ™‚ã®ã¿è¡¨ç¤º) -->
                <div id="setup-progress" class="status-info-section">
                    <div class="status-info-title">ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—é€²è¡Œ</div>
                    <div class="flex items-center space-x-4 text-xs mt-2">
                        <div class="flex items-center">
                            <div id="active-status" class="w-2 h-2 rounded-full bg-red-500 mr-2"></div>
                            <span class="text-gray-300">ãƒãƒˆãƒ«å ´</span>
                        </div>
                        <div class="flex items-center">
                            <div id="bench-status" class="w-2 h-2 rounded-full bg-gray-500 mr-2"></div>
                            <span class="text-gray-300">ãƒ™ãƒ³ãƒ (<span id="bench-count">0</span>/5)</span>
                        </div>
                    </div>
                </div>

                <!-- Prize Cards Status -->
                <div id="prize-status" class="status-info-section">
                    <div class="status-info-title">ã‚µã‚¤ãƒ‰ã‚«ãƒ¼ãƒ‰</div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
                            <span class="text-sm text-blue-200">YOU</span>
                            <span id="player-prize-count" class="font-bold text-white">6/6</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
                            <span class="text-sm text-red-200">CPU</span>
                            <span id="cpu-prize-count" class="font-bold text-white">6/6</span>
                        </div>
                    </div>
                </div>

                <!-- Current Message Area -->
                <div class="status-info-section">
                    <div class="status-info-title">ç¾åœ¨ã®çŠ¶æ³</div>
                    <div class="game-message-area">
                        <div id="game-message-display" class="game-message-text">
                            ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¦ãã ã•ã„
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </div>

    <!-- Card Info Panel -->
    <div id="card-info-panel" class="hidden fixed"></div>



    <script>
        // Expose noop globally so modules can reuse it without errors
        // GitHub Pagesç’°å¢ƒã§ã¯é™çš„ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°ã®ãŸã‚ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’æœ€å°åŒ–
        window.noop = console.log ? console.log.bind(console) : () => { };

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼šä¸è¦ãªãƒ­ã‚°ã‚’åˆ¶é™
        if (window.location.hostname.includes('github.io')) {
            console.log = () => { };
            console.debug = () => { };
            window.noop = () => { };
        }
        // âœ… Three.jså°‚ç”¨ãƒ¢ãƒ¼ãƒ‰: ãƒ—ãƒ¬ã‚¤ãƒãƒƒãƒˆãƒ‡ãƒ¼ã‚¿ã®ã¿èª­ã¿è¾¼ã¿
        document.addEventListener('DOMContentLoaded', async () => {
            // JSONã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒãƒƒãƒˆã®ã‚¹ãƒ­ãƒƒãƒˆæƒ…å ±ã‚’èª­ã¿è¾¼ã¿ï¼ˆThree.jsç”¨ï¼‰
            let data = null;
            try {
                const res = await fetch('./assets/playmat/playmat_slots_named.json');
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                data = await res.json();
                window.playmatSlotsData = data; // Three.jsãŒã‚¢ã‚¯ã‚»ã‚¹
                console.log('âœ… Playmat slot data loaded successfully');
            } catch (e) {
                console.error('âŒ Failed to load playmat slot data:', e);
                console.warn('âš ï¸ Using fallback layout without slot positioning');
                return;
            }

            // ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
            const cardEditorButton = document.getElementById('card-editor-button-float');
            if (cardEditorButton) {
                cardEditorButton.addEventListener('click', () => {
                    const editorUrl = 'card_viewer.html';
                    const editorWindow = window.open(editorUrl, '_blank', 'noopener,noreferrer');
                    if (!editorWindow) {
                        const shouldNavigate = window.confirm('ã‚«ãƒ¼ãƒ‰ã‚¨ãƒ‡ã‚£ã‚¿ã‚’æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚ç¾åœ¨ã®ã‚¿ãƒ–ã§é–‹ãã¨ã‚²ãƒ¼ãƒ é€²è¡ŒçŠ¶æ³ãŒå¤±ã‚ã‚Œã¾ã™ã€‚é–‹ãã¾ã™ã‹ï¼Ÿ');
                        if (shouldNavigate) {
                            window.location.href = editorUrl;
                        }
                    }
                });
            }

            // 3Dè¨­å®šã¯Three.js (scene.js) ã§ç®¡ç†ã€CSSå¤‰æ•°ã¯ä¸è¦
        });

        // ================= Debug helpers =================
        /* Debug helpers removed */
        function getStyles(el) {
            const cs = window.getComputedStyle(el);
            return {
                position: cs.position,
                left: cs.left,
                top: cs.top,
                width: cs.width,
                height: cs.height,
                zIndex: cs.zIndex,
                display: cs.display,
                visibility: cs.visibility,
                opacity: cs.opacity,
                pointerEvents: cs.pointerEvents,
                transform: cs.transform,
                transformStyle: cs.transformStyle,
                willChange: cs.willChange
            };
        }
        // Debug helpers removed
    </script>
    <!-- Action Modal -->
    <div id="action-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center"
        style="z-index: var(--z-modals);"></div>

    <script type="module">
        // Modal Manager ã®åˆæœŸåŒ–
        try {
            const { modalManager } = await import('/src/js/modal-manager.js');
            const noop = window.noop || (() => { });

            // DOMæº–å‚™å®Œäº†å¾Œã«Modal Managerã‚’åˆæœŸåŒ–
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    modalManager.init();
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
                });
            } else {
                modalManager.init();
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
            }
        } catch (e) {
            console.warn('âš ï¸ Modal Manager module not available:', e.message);
        }
    </script>
    <script type="module">
        // ã‚²ãƒ¼ãƒ åˆæœŸåŒ–ã®ãƒ¡ã‚¤ãƒ³å‡¦ç†
        // main.jsã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹

        try {
            const module = await import('/src/js/main.js');
            // main.jsã‚¤ãƒ³ãƒãƒ¼ãƒˆæˆåŠŸ

            // åˆæœŸåŒ–å®Œäº†ã‚’å¾…æ©Ÿ
            if (!window.game) {
                console.log('â³ HTML: Waiting for game initialization...');
                window.addEventListener('gameInitialized', (event) => {
                    const { success, game, error } = event.detail;
                    if (success) {
                        console.log('ğŸ‰ HTML: Game initialized successfully!');
                    } else {
                        console.error('ğŸ’¥ HTML: Game initialization failed:', error);
                        showInitializationError(error);
                    }
                });
            }

        } catch (e) {
            console.error('âŒ HTML: Failed to import main.js:', e);
            showInitializationError(e);
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºæ©Ÿèƒ½
        function showInitializationError(error) {
            console.log('ğŸš¨ HTML: Showing initialization error to user');

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
            const errorModal = document.createElement('div');
            errorModal.id = 'initialization-error-modal';
            errorModal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: var(--z-critical);
                font-family: system-ui, sans-serif;
            `;

            errorModal.innerHTML = `
                <div style="
                    background: #1a1a1a;
                    color: #fff;
                    padding: 30px;
                    border-radius: 10px;
                    max-width: 500px;
                    text-align: center;
                    border: 2px solid #ff6b6b;
                ">
                    <h2 style="color: #ff6b6b; margin-bottom: 15px;">âš ï¸ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2>
                    <p style="margin-bottom: 20px; line-height: 1.5;">
                        ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚<br>
                        ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
                    </p>
                    <details style="text-align: left; margin-bottom: 20px; font-size: 12px;">
                        <summary style="cursor: pointer; color: #ccc;">è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±</summary>
                        <pre style="
                            background: #333;
                            padding: 10px;
                            border-radius: 5px;
                            overflow: auto;
                            margin-top: 10px;
                            white-space: pre-wrap;
                        ">${error.message || error}</pre>
                    </details>
                    <button onclick="location.reload()" style="
                        background: #4caf50;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                        margin-right: 10px;
                    ">ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿</button>
                    <button onclick="this.parentElement.parentElement.remove()" style="
                        background: #666;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 5px;
                        cursor: pointer;
                        font-size: 14px;
                    ">é–‰ã˜ã‚‹</button>
                </div>
            `;

            document.body.appendChild(errorModal);
        }
    </script>
    <!-- Howler.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.4/howler.min.js"></script>

</body>

</html>
