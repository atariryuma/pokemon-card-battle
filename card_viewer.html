<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ ã‚¨ãƒ‡ã‚£ã‚¿</title>
  <link rel="stylesheet" href="assets/z-index-vars.css">
  <style>
    :root {
      --bg: #0f1226;
      --panel: #15193a;
      --panel-2: #1c2252;
      --text: #e7ecff;
      --muted: #9fb0ff;
      --accent: #6ea8ff;
      --accent-2: #8ef6ff;
      --danger: #ff6b6b;
      --ok: #2ecc71;
      --warn: #f1c40f;
      --border: rgba(255,255,255,0.1);
      --chip: #2b3169;
      --shadow: 0 12px 32px rgba(0,0,0,.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", Meiryo, "Noto Sans JP", sans-serif;
      color: var(--text);
      background: radial-gradient(1200px 600px at 10% -10%, #2945b5 0%, transparent 60%),
                  radial-gradient(1200px 600px at 110% 10%, #4026a7 0%, transparent 60%),
                  var(--bg);
      overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«ç„¡åŠ¹ */
      font-size: 14px;
      height: 100vh; /* é«˜ã•ã‚’ç”»é¢å…¨ä½“ã«å›ºå®š */
      width: 100vw; /* å¹…ã‚’ç”»é¢å…¨ä½“ã«å›ºå®š */
    }

    header {
      position: sticky; top: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(15,18,38,.95) 0%, rgba(15,18,38,.75) 100%);
      backdrop-filter: blur(6px);
      border-bottom: 1px solid var(--border);
      padding: 10px 15px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    
    header h1 {
      flex: 1;
      min-width: 200px;
      margin: 0;
      font-size: 18px;
      letter-spacing: .5px;
    }
    
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    .muted { color: var(--muted); }

    .btn {
      appearance: none;
      border: 1px solid var(--border);
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: .15s ease transform, .2s ease filter, .2s ease box-shadow;
      box-shadow: 0 2px 0 rgba(0,0,0,.3) inset, 0 1px 0 rgba(255,255,255,.04) inset;
      font-weight: 600; font-size: 13px;
    }
    .btn:hover { filter: brightness(1.2); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { border-color: rgba(110,168,255,.5); box-shadow: 0 0 0 1px rgba(110,168,255,.25); }
    .btn.warn { border-color: rgba(241,196,15,.5); }
    .btn.danger { border-color: rgba(255,107,107,.5); }
    .btn.ghost { background: transparent; }

    .toolbar { display: flex; gap: 8px; align-items: center; }
    .spacer { flex: 1; }
    .kbd { background: var(--chip); padding: 3px 8px; border-radius: 6px; border:1px solid var(--border); font-size: 14px; }

    .container { 
      display: grid; 
      gap: 8px; 
      padding: 8px; 
      height: calc(100vh - 60px); /* ãƒ˜ãƒƒãƒ€ãƒ¼åˆ†ã‚’å¼•ã„ã¦å›ºå®šé«˜ */
      grid-template-columns: 1fr;
      width: 100%;
      overflow: hidden; /* ã‚³ãƒ³ãƒ†ãƒŠå†…ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç„¡åŠ¹ */
    }
    .panel {
      background: linear-gradient(180deg, rgba(21,25,58,.85) 0%, rgba(28,34,82,.85) 100%);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 0;
      height: 100%; /* ãƒ‘ãƒãƒ«é«˜ã•ã‚’è¦ªã«åˆã‚ã›ã‚‹ */
      max-height: 100%; /* æœ€å¤§é«˜ã•åˆ¶é™ */
    }
    .panel h2 { font-size: 16px; margin: 0; padding: 10px 12px; border-bottom: 1px solid var(--border); background: rgba(0,0,0,.15); }
    .panel .content { padding: 10px 12px; flex: 1; overflow: auto; min-height: 0; }

    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .field { display: grid; gap: 6px; margin-bottom: 10px; }
    .field label { font-size: 13px; color: var(--muted); font-weight: 600; }
    .field input, .field select, .field textarea {
      width: 100%;
      background: rgba(0,0,0,.2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 10px; padding: 8px 10px; font-size: 13px;
    }
    .field textarea { min-height: 70px; resize: vertical; }
    .chips { display:flex; flex-wrap: wrap; gap:6px; }
    .chip { background: var(--chip); padding: 4px 8px; border-radius: 20px; border:1px solid var(--border); font-size: 12px; }
    .hint { color: var(--muted); font-size: 14px; }

    .list-toolbar { padding: 10px; border-bottom: 1px solid var(--border); display:flex; gap:8px; align-items:center; }
    .search { flex: 1; }
    .search input { width: 100%; padding: 8px 10px; border-radius: 10px; border:1px solid var(--border); background: rgba(0,0,0,.2); color: var(--text); }

    .list { flex: 1; overflow: auto; outline: none; }
    .card-item { display:grid; grid-template-columns: auto 1fr auto; gap:10px; align-items:center; padding: 8px 10px; border-bottom:1px solid var(--border); cursor:pointer; }
    .card-item:hover { background: rgba(255,255,255,.04); }
    .card-item.active { background: rgba(110,168,255,.15); }
    .badge { padding: 3px 10px; border-radius: 16px; font-size: 13px; border:1px solid var(--border); background: rgba(255,255,255,.06); }
    .badge.pokemon { color:#ffd2d2; border-color: rgba(255,107,107,.4) }
    .badge.energy { color:#fff0b6; border-color: rgba(241,196,15,.4) }
    .badge.trainer{ color:#b8e1ff; border-color: rgba(142,246,255,.4) }
    .count { font-size: 14px; color: var(--muted); padding: 0 10px 10px; }

    .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .flex-row { display:flex; gap:8px; }
    .right { text-align: right; }

    .section { margin: 8px 0 14px; padding-top: 8px; border-top:1px dashed var(--border); }
    .section h3 { font-size: 15px; margin: 0 0 8px; color: var(--muted); font-weight: 600; }

    .attacks { display: grid; gap: 8px; }
    .attack-box { border:1px solid var(--border); background: rgba(0,0,0,.15); border-radius: 10px; padding: 10px; }
    .attack-grid { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:8px; }

    .footer { padding: 12px 16px; display:flex; gap: 8px; align-items:center; border-top:1px solid var(--border); background: rgba(0,0,0,.15); }
    .status { font-size: 14px; color: var(--muted); }

    .danger-zone { border:1px solid rgba(255,107,107,.3); background: rgba(255,107,107,.06); border-radius: 12px; padding: 10px; }
    .small { font-size: 14px; }

    .invisible { display:none; }

    /* Preview styles */
    #preview-wrap { display:flex; flex-direction: column; min-height: 0; }
    #preview-stage { position: relative; flex: 1; min-height: 260px; background: repeating-conic-gradient(#1a1f4a 0 25%, #10143a 0 50%) 50% / 18px 18px; border: 1px solid var(--border); border-radius: 10px; overflow: hidden; display:flex; align-items:center; justify-content:center; }
    #preview-img { max-width: 100%; max-height: 100%; transform-origin: center center; user-select: none; image-rendering: auto; }
    #preview-empty { position: absolute; color: var(--muted); font-size: 15px; }

    /* Drawer */
    #drawer { position: fixed; inset: 0; pointer-events: none; }
    .drawer-panel { position: absolute; top: 0; left: -420px; width: 380px; height: 100%; background: linear-gradient(180deg, rgba(21,25,58,.98) 0%, rgba(28,34,82,.98) 100%); border-right: 1px solid var(--border); box-shadow: var(--shadow); transition: left .25s ease; display:flex; flex-direction:column; pointer-events: auto; z-index: 1001; }
    .drawer-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,.35); opacity: 0; transition: opacity .25s ease; z-index: 1000; }
    #drawer.open .drawer-panel { left: 0; }
    #drawer.open .drawer-backdrop { opacity: 1; pointer-events: auto; }
    #btn-open-drawer { white-space: nowrap; }

    /* Header unsaved indicator */
    header h1::after { content: var(--unsaved-dot, ""); margin-left: 8px; color: var(--warn); }
  
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
    
    /* å¤§ç”»é¢: ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ãƒ»TV (1400pxä»¥ä¸Š) */
    @media (min-width: 1400px) {
      .container {
        grid-template-columns: minmax(420px, 40vw) 1fr;
        gap: 12px;
        padding: 12px;
        height: calc(100vh - 70px);
      }
      header {
        padding: 12px 20px;
      }
    }
    
    /* ä¸­å¤§ç”»é¢: ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ— (1000px - 1399px) */
    @media (min-width: 1000px) and (max-width: 1399px) {
      .container {
        grid-template-columns: minmax(380px, 45vw) 1fr;
        gap: 10px;
        padding: 10px;
        height: calc(100vh - 65px);
      }
    }
    
    /* ä¸­ç”»é¢: ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆæ¨ª (768px - 999px) */
    @media (min-width: 768px) and (max-width: 999px) {
      .container {
        grid-template-columns: minmax(320px, 50vw) 1fr;
        gap: 8px;
        padding: 8px;
        height: calc(100vh - 60px);
      }
      header {
        padding: 8px 12px;
      }
    }
    
    /* å°ç”»é¢: ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆç¸¦ãƒ»å¤§ãã‚ã‚¹ãƒãƒ› (600px - 767px) */
    @media (min-width: 600px) and (max-width: 767px) {
      header {
        padding: 6px 10px;
        flex-direction: column;
        gap: 6px;
        height: 80px;
      }
      header h1 {
        text-align: center;
      }
      .container {
        grid-template-columns: 1fr;
        gap: 6px;
        padding: 6px;
        height: calc(100vh - 80px);
      }
      .grid-2 {
        grid-template-columns: 1fr;
        gap: 6px;
      }
    }
    
    /* æ¥µå°ç”»é¢: ã‚¹ãƒãƒ› (599pxä»¥ä¸‹) */
    @media (max-width: 599px) {
      header {
        padding: 4px 6px;
        flex-direction: column;
        gap: 4px;
        height: 90px;
      }
      header h1 {
        text-align: center;
      }
      header h1 .muted {
        display: none;
      }
      .toolbar {
        justify-content: center;
        gap: 4px;
      }
      .container {
        grid-template-columns: 1fr;
        padding: 4px;
        gap: 4px;
        height: calc(100vh - 90px);
      }
      .panel {
        border-radius: 6px;
      }
      .panel h2 {
        padding: 6px 8px;
      }
      .field input, .field select, .field textarea {
        padding: 4px 6px;
      }
      .grid-2 {
        grid-template-columns: 1fr;
        gap: 4px;
      }
      .drawer-panel {
        width: 100vw;
        left: -100vw;
      }
      #drawer.open .drawer-panel {
        left: 0;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ ã‚¨ãƒ‡ã‚£ã‚¿ <span class="muted small">(cards-master.json / data/cards)</span></h1>
    <div class="toolbar">
      <button type="button" class="btn primary" id="btn-back-to-game">ğŸ® ã‚²ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
      <div class="spacer"></div>
      <button type="button" class="btn" id="btn-open-drawer">ã‚«ãƒ¼ãƒ‰ä¸€è¦§ (Ctrl+K)</button>
      <button type="button" class="btn" id="btn-new-card">æ–°è¦ä½œæˆ</button>
      <button type="button" class="btn" id="btn-open-master">masterèª­è¾¼</button>
      <button type="button" class="btn primary" id="btn-save-master">masterä¿å­˜</button>
      <button type="button" class="btn" id="btn-fix-extensions">æ‹¡å¼µå­ä¿®æ­£</button>
    </div>
  </header>

  <div class="container">
    <section class="panel" id="preview-panel">
      <h2>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h2>
      <div class="content" id="preview-wrap">
        <div id="preview-stage">
          <img id="preview-img" alt="preview" />
          <div id="preview-empty">ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç”»åƒã‚’é¸æŠ/ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚</div>
        </div>
        <div class="flex-row" style="align-items:center; margin-top:8px;">
          <div class="toolbar">
            <button type="button" class="btn" id="btn-zoom-out">-</button>
            <input type="range" id="zoom" min="0.5" max="3" value="1" step="0.1" title="ã‚ºãƒ¼ãƒ " aria-label="ã‚ºãƒ¼ãƒ " style="width:160px"/>
            <button type="button" class="btn" id="btn-zoom-in">+</button>
            <button type="button" class="btn" id="btn-fit">ãƒ•ã‚£ãƒƒãƒˆ</button>
            <button type="button" class="btn" id="btn-actual">ç­‰å€</button>
          </div>
          <div class="spacer"></div>
          <div class="toolbar">
            <button type="button" class="btn" id="btn-prev">â† å‰ã¸</button>
            <button type="button" class="btn" id="btn-next">æ¬¡ã¸ â†’</button>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="editor-panel">
      <h2>ã‚«ãƒ¼ãƒ‰ç·¨é›†</h2>
      <div class="content">
        <form id="cardForm">
          <div class="grid-2">
            <div class="field"><label for="id">IDï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰</label><input id="id" required readonly title="è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ID" style="background-color: rgba(0,0,0,0.3); cursor: not-allowed;" /></div>
            <div class="field"><label for="card_type">ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥</label>
              <select id="card_type" required title="ã‚«ãƒ¼ãƒ‰ã®ç¨®åˆ¥ã‚’é¸æŠ">
                <option value="Pokemon">Pokemon</option>
                <option value="Energy">Energy</option>
                <option value="Trainer">Trainer</option>
              </select>
            </div>
          </div>
          <div class="grid-2">
            <div class="field"><label for="name_en">è‹±å (name_en)</label><input id="name_en" required title="è‹±èªå" /></div>
            <div class="field"><label for="name_ja">å’Œå (name_ja)</label><input id="name_ja" required title="æ—¥æœ¬èªå" /></div>
          </div>

          <div id="pokemonFields" class="section">
            <h3>ãƒã‚±ãƒ¢ãƒ³</h3>
            <div class="grid-2">
              <div class="field"><label for="stage">ã‚¹ãƒ†ãƒ¼ã‚¸</label>
                <select id="stage" title="é€²åŒ–ã‚¹ãƒ†ãƒ¼ã‚¸">
                  <option value="">-</option>
                  <option value="Basic">Basic</option>
                  <option value="Stage1">Stage1</option>
                  <option value="Stage2">Stage2</option>
                </select>
              </div>
              <div class="field"><label for="hp">HP</label><input id="hp" type="number" min="0" title="ãƒ’ãƒƒãƒˆãƒã‚¤ãƒ³ãƒˆ" /></div>
            </div>
            <div class="grid-2">
              <div class="field"><label for="evolves_from">é€²åŒ–å‰ (evolves_from)</label><input id="evolves_from" title="é€²åŒ–å‰ã®ãƒã‚±ãƒ¢ãƒ³å"/></div>
              <div class="field"><label for="evolves_to">é€²åŒ–å…ˆ (evolves_to, ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label><input id="evolves_to" title="é€²åŒ–å…ˆã®ãƒã‚±ãƒ¢ãƒ³åï¼ˆè¤‡æ•°ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰"/></div>
            </div>
            <div class="grid-2">
              <div class="field"><label for="types">ã‚¿ã‚¤ãƒ— (types, ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Š)</label><input id="types" placeholder="Grass, Colorless ç­‰" title="ãƒã‚±ãƒ¢ãƒ³ã®ã‚¿ã‚¤ãƒ—ï¼ˆè¤‡æ•°ã¯ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰"/></div>
              <div class="field"><label for="rule_box">ãƒ«ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹</label>
                <select id="rule_box" title="ãƒ«ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹ã®ç¨®é¡">
                  <option value="">ãªã—</option>
                  <option value="ex">ex</option>
                  <option value="V">V</option>
                  <option value="VMAX">VMAX</option>
                </select>
              </div>
            </div>
            <div class="grid-2">
              <div class="field"><label for="weakness">å¼±ç‚¹ (ä¾‹: Lightning:x2; Fire:+)</label><input id="weakness" placeholder="type:value; type:value" title="å¼±ç‚¹è¨­å®š"/></div>
              <div class="field"><label for="resistance">æŠµæŠ—åŠ› (ä¾‹: Fighting:-30)</label><input id="resistance" placeholder="type:value (1ã¤ã®ã¿)" title="æŠµæŠ—åŠ›è¨­å®š"/></div>
            </div>
            <div class="grid-2">
              <div class="field"><label for="retreat_cost">ã«ã’ã‚‹ã‚¨ãƒæ•° (retreat_cost)</label><input id="retreat_cost" type="number" min="0" max="5" title="ã«ã’ã‚‹ã®ã«å¿…è¦ãªã‚¨ãƒãƒ«ã‚®ãƒ¼æ•°"/></div>
              <div class="field"><label for="ability_name">ç‰¹æ€§ å (ability.name_ja / en)</label><input id="ability_name" title="ç‰¹æ€§ã®åå‰"/></div>
            </div>
            <div class="field"><label>ç‰¹æ€§ ãƒ†ã‚­ã‚¹ãƒˆ (text_ja / text_en)</label><textarea id="ability_text" placeholder="æ—¥/è‹±ã¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥åŒºåˆ‡ã‚Š (æ—¥æœ¬èª / English)"></textarea></div>

            <div class="section">
              <div class="flex-row" style="justify-content:space-between; align-items:center;">
                <h3>ãƒ¯ã‚¶ (attacks)</h3>
                <button type="button" class="btn small" id="btn-add-attack">+ è¿½åŠ </button>
              </div>
              <div class="attacks" id="attacks"></div>
            </div>
          </div>

          <div id="energyFields" class="section">
            <h3>ã‚¨ãƒãƒ«ã‚®ãƒ¼</h3>
            <div class="field">
              <label for="energy_type">ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚¿ã‚¤ãƒ—</label>
              <select id="energy_type" title="ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ç¨®é¡">
                <option value="">-</option>
                <option>Grass</option><option>Fire</option><option>Water</option>
                <option>Lightning</option><option>Psychic</option><option>Fighting</option>
                <option>Darkness</option><option>Metal</option><option>Fairy</option>
                <option>Dragon</option><option>Colorless</option>
              </select>
            </div>
            <div class="field">
              <label>ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ (effect_ja / effect_en)</label>
              <textarea id="energy_effect" placeholder="æ—¥æœ¬èªã‚¨ãƒ•ã‚§ã‚¯ãƒˆ / English effect"></textarea>
            </div>
            <div class="field">
              <label>ãƒ«ãƒ¼ãƒ« (rules_ja / rules_en)</label>
              <textarea id="energy_rules" placeholder="æ—¥æœ¬èªãƒ«ãƒ¼ãƒ« / English rules"></textarea>
            </div>
          </div>

          <div id="trainerFields" class="section">
            <h3>ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼</h3>
            <div class="grid-2">
              <div class="field"><label for="trainer_type">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚¿ã‚¤ãƒ—</label>
                <select id="trainer_type" title="ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚«ãƒ¼ãƒ‰ã®ç¨®é¡">
                  <option value="">-</option>
                  <option>Item</option>
                  <option>Supporter</option>
                  <option>Stadium</option>
                </select>
              </div>
            </div>
            <div class="field"><label>ãƒ†ã‚­ã‚¹ãƒˆ (text_ja / text_en)</label><textarea id="trainer_text" placeholder="æ—¥æœ¬èª / English"></textarea></div>
          </div>

          <div class="section">
            <h3>ç”»åƒ</h3>
            <div class="field">
              <label for="image_file">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å</label>
              <input id="image_file" placeholder="è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™" title="ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«å" readonly style="background: rgba(0,0,0,0.1);"/>
            </div>
            
            <!-- éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› -->
            <input type="file" id="image_upload" accept="image/*" style="display: none;" title="ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ"/>
            
            <div class="flex-row" style="align-items:center; gap:8px; margin-top:12px; flex-wrap: wrap;">
              <button type="button" class="btn primary" id="btn-pick-image">ğŸ–¼ï¸ ç”»åƒã‚’é¸æŠ</button>
              <button type="button" class="btn" id="btn-gallery">ğŸ“ æ—¢å­˜ç”»åƒ</button>
            </div>
            
            <!-- ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤ºã•ã‚Œã‚‹æ“ä½œãƒœã‚¿ãƒ³ -->
            <div id="image-actions" style="margin-top:8px; display:none;">
              <div class="flex-row" style="gap:8px; flex-wrap: wrap;">
                <button type="button" class="btn" id="btn-optimize-image">âš¡ WebPæœ€é©åŒ–</button>
                <button type="button" class="btn btn-danger" id="btn-delete-image">ğŸ—‘ï¸ å‰Šé™¤</button>
              </div>
            </div>
            
            <div id="image-upload-status" style="font-size: 12px; color: var(--text-secondary); margin-top: 8px; display: none;">
              <!-- ç”»åƒçŠ¶æ³ã‚’è¡¨ç¤º -->
            </div>
          </div>
        </form>
      </div>
      <div class="footer">
        <div class="toolbar">
          <button type="button" class="btn" id="btn-duplicate">è¤‡è£½</button>
          <button type="button" class="btn danger" id="btn-delete">å‰Šé™¤</button>
        </div>
        <div class="spacer"></div>
        <div class="status" id="status">æº–å‚™ä¸­...</div>
      </div>
    </section>
  </div>

  <!-- Slide-out drawer: ã‚«ãƒ¼ãƒ‰ä¸€è¦§ -->
  <aside id="drawer" aria-hidden="true">
    <div class="drawer-panel">
      <div class="list-toolbar">
        <div class="search"><input id="search" placeholder="æ¤œç´¢: è‹±å/å’Œå/ID (Escã§é–‰ã˜ã‚‹)" /></div>
        <select id="filterType" class="btn">
          <option value="all">å…¨ã¦</option>
          <option value="Pokemon">ãƒã‚±ãƒ¢ãƒ³</option>
          <option value="Energy">ã‚¨ãƒãƒ«ã‚®ãƒ¼</option>
          <option value="Trainer">ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼</option>
        </select>
        <button type="button" class="btn" id="btn-new">æ–°è¦</button>
        <button type="button" class="btn ghost" id="btn-close-drawer">âœ•</button>
      </div>
      <div class="count" id="count"></div>
      <div class="list" id="cardList"></div>
    </div>
    <div class="drawer-backdrop" id="drawer-backdrop"></div>
  </aside>

  <!-- Modal -->
  <div id="modal" class="invisible">
    <div id="modal-backdrop" style="position:fixed; inset:0; background:rgba(0,0,0,.45);"></div>
    <div id="modal-panel" style="position:fixed; top:10%; left:50%; transform:translateX(-50%); width: min(720px, 92vw); max-height: 80vh; overflow:auto; background: linear-gradient(180deg, rgba(21,25,58,.98), rgba(28,34,82,.98)); border:1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow); padding: 16px;"></div>
  </div>

  <script>
    // --------- å‹ãƒ»åˆæœŸãƒ‡ãƒ¼ã‚¿
    const defaultCard = () => ({ id: '', name_en: '', name_ja: '', card_type: 'Pokemon' });
    let cards = [];
    let filtered = [];
    let activeIndex = -1;

    let unsaved = false;                   // æœªä¿å­˜ãƒ•ãƒ©ã‚°

    // Preview state
    let zoomLevel = 1;
    let pan = { x: 0, y: 0 };
    let isPanning = false;
    let panStart = { x: 0, y: 0 };
    let lastPan = { x: 0, y: 0 };

    // --------- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const byId = (id) => document.getElementById(id);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    // --------- IDè‡ªå‹•ç”Ÿæˆ
    /**
     * IDç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆdata-manager.jsã¨çµ±ä¸€ï¼‰
     * 3æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°å½¢å¼ã§ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ
     */
    function generateNextId() {
      const usedIds = new Set();
      let nextAutoId = 1;
      
      // æ—¢å­˜IDã‚’åé›†ãƒ»æ­£è¦åŒ–
      cards.forEach(c => {
        if (c.id) {
          // IDã‚’3æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°å½¢å¼ã«æ­£è¦åŒ–
          const numericId = parseInt(c.id, 10);
          if (!isNaN(numericId) && numericId > 0) {
            const normalizedId = String(numericId).padStart(3, '0');
            usedIds.add(normalizedId);
            nextAutoId = Math.max(nextAutoId, numericId + 1);
          } else {
            // æ•°å€¤ä»¥å¤–ã®IDã‚‚ãã®ã¾ã¾è¨˜éŒ²
            usedIds.add(String(c.id));
          }
        }
      });
      
      // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ç”Ÿæˆ
      let candidateId = nextAutoId;
      let formattedId;
      
      do {
        formattedId = String(candidateId).padStart(3, '0');
        candidateId++;
      } while (usedIds.has(formattedId));
      
      console.log(`ğŸ†” Generated new ID: ${formattedId} (next available after checking ${usedIds.size} existing IDs)`);
      return formattedId;
    }

    const schemaGuard = (obj) => {
      // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  â†’ ã‚¹ã‚­ãƒ¼ãƒæ•´å½¢
      const card_type = byId('card_type').value;
      const base = {
        id: byId('id').value.trim(),
        name_en: byId('name_en').value.trim(),
        name_ja: byId('name_ja').value.trim(),
        card_type
      };
      if (card_type === 'Pokemon') {
        const abilityText = byId('ability_text').value.trim();
        const [ability_ja, ability_en_text] = abilityText.split('/').map(s => (s||'').trim());
        const weakStr = byId('weakness').value.trim();
        const weakness = weakStr ? weakStr.split(';').map(s => s.trim()).filter(Boolean).map(tok => {
          const [type, value] = tok.split(':').map(t=>t.trim());
          return { type, value };
        }) : undefined;
        const resStr = byId('resistance').value.trim();
        const resistance = resStr ? (()=>{ const [type,value] = resStr.split(':').map(s=>s.trim()); return { type, value }; })() : undefined;

        obj = {
          ...base,
          stage: byId('stage').value || undefined,
          evolves_from: byId('evolves_from').value.trim() || undefined,
          evolves_to: (byId('evolves_to').value.trim() ? byId('evolves_to').value.split(',').map(s=>s.trim()).filter(Boolean) : undefined),
          hp: byId('hp').value ? Number(byId('hp').value) : undefined,
          types: (byId('types').value.trim() ? byId('types').value.split(',').map(s=>s.trim()).filter(Boolean) : undefined),
          rule_box: (byId('rule_box').value || undefined),
          weakness,
          resistance,
          retreat_cost: byId('retreat_cost').value ? Number(byId('retreat_cost').value) : 0,
          ability: (byId('ability_name').value.trim() || abilityText) ? {
            name_en: byId('ability_name').value.trim() || '',
            name_ja: byId('ability_name').value.trim() || '',
            text_en: ability_en_text || '',
            text_ja: ability_ja || ''
          } : undefined,
          attacks: readAttacksFromForm(),
        };
      } else if (card_type === 'Energy') {
        const effectTxt = byId('energy_effect').value.trim();
        const [effectJa, effectEn] = effectTxt.split('/').map(s => (s||'').trim());
        const rulesTxt = byId('energy_rules').value.trim();
        const [rulesJa, rulesEn] = rulesTxt.split('/').map(s => (s||'').trim());
        obj = {
          ...base,
          energy_type: byId('energy_type').value || undefined,
          effect_en: effectEn || undefined,
          effect_ja: effectJa || undefined,
          rules_en: rulesEn || undefined,
          rules_ja: rulesJa || undefined,
        };
      } else if (card_type === 'Trainer') {
        const txt = byId('trainer_text').value.trim();
        const [ja, en] = txt.split('/').map(s => (s||'').trim());
        obj = {
          ...base,
          trainer_type: byId('trainer_type').value || undefined,
          text_en: en || undefined,
          text_ja: ja || undefined,
        };
      }
      const img = byId('image_file').value.trim();
      if (img) obj.image_file = img; // ä»»æ„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£
      return compactObject(obj);
    };

    function compactObject(o){
      if (o === null || o === undefined) return undefined;
      if (Array.isArray(o)) {
        const arr = o.map(compactObject).filter(v => v !== undefined);
        return arr.length ? arr : undefined;
      }
      if (typeof o === 'object') {
        const out = {};
        for (const [k,v] of Object.entries(o)) {
          const vv = compactObject(v);
          if (vv !== undefined && vv !== '') out[k] = vv;
        }
        return Object.keys(out).length ? out : undefined;
      }
      return o;
    }

    function readAttacksFromForm(){
      const containers = $$('#attacks .attack-box');
      return containers.map(node => {
        const name = node.querySelector('.atk-name').value.trim();
        const nameEn = node.querySelector('.atk-name-en').value.trim();
        const cost = node.querySelector('.atk-cost').value.trim();
        const dmg = node.querySelector('.atk-dmg').value;
        const text = node.querySelector('.atk-text').value.trim();
        const [ja, en] = text.split('/').map(s => (s||'').trim());
        const costArray = cost ? cost.split(',').map(s=>s.trim()).filter(Boolean) : [];
        const atk = {
          name_ja: name || undefined,
          name_en: nameEn || undefined,
          cost: costArray,
        };
        if (dmg !== '') atk.damage = Number(dmg);
        if (ja) atk.text_ja = ja;
        if (en) atk.text_en = en;
        return atk;
      });
    }

    function writeAttacksToForm(attacks){
      const root = byId('attacks');
      root.innerHTML = '';
      (attacks || []).forEach((a, idx) => root.appendChild(createAttackBox(a, idx)));
    }

    function createAttackBox(a = {}, idx = 0){
      const box = document.createElement('div');
      box.className = 'attack-box';
      box.innerHTML = `
        <div class="attack-grid">
          <div class="field"><label>æŠ€å(å’Œ)</label><input class="atk-name" value="${a.name_ja||''}"></div>
          <div class="field"><label>æŠ€å(è‹±)</label><input class="atk-name-en" value="${a.name_en||''}"></div>
          <div class="field"><label>ã‚³ã‚¹ãƒˆ(ã‚«ãƒ³ãƒ)</label><input class="atk-cost" placeholder="Grass,Colorless" value="${(a.cost||[]).join(',')}"></div>
        </div>
        <div class="attack-grid">
          <div class="field"><label>ãƒ€ãƒ¡ãƒ¼ã‚¸</label><input class="atk-dmg" type="number" min="0" value="${a.damage ?? ''}"></div>
          <div class="field" style="grid-column: span 2"><label>ãƒ†ã‚­ã‚¹ãƒˆ(æ—¥/è‹±)</label><input class="atk-text" placeholder="æ—¥æœ¬èª / English" value="${[a.text_ja||'', a.text_en||''].filter((x,i)=>x&&(i<2)).join(' / ')}"></div>
        </div>
        <div class="right"><button type="button" class="btn danger btn-del-atk">å‰Šé™¤</button></div>
      `;
      box.querySelector('.btn-del-atk').addEventListener('click', () => {
        box.remove();
      });
      return box;
    }

    function setStatus(msg){ byId('status').textContent = msg; }
    function markUnsaved(flag = true){
      unsaved = flag;
      document.documentElement.style.setProperty('--unsaved-dot', flag ? '"â—"' : '""');
      if (flag) setStatus('æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™');
    }

    // --------- ãƒªã‚¹ãƒˆè¡¨ç¤º
    function renderList(){
      const q = byId('search').value.trim().toLowerCase();
      const f = byId('filterType').value;
      filtered = cards.filter(c =>
        (f==='all'||c.card_type===f) &&
        ([c.id, c.name_en, c.name_ja].join(' ').toLowerCase().includes(q))
      );
      const list = byId('cardList');
      list.innerHTML = '';
      filtered.forEach((c, i) => {
        const row = document.createElement('div');
        const isActive = cards[activeIndex] === c;
        row.className = 'card-item' + (isActive ? ' active' : '');
        const badgeClass = c.card_type === 'Pokemon' ? 'pokemon' : (c.card_type === 'Energy' ? 'energy' : 'trainer');
        row.innerHTML = `
          <span class="badge ${badgeClass}">${c.card_type}</span>
          <div>
            <div><strong>${c.name_ja||''}</strong> <span class="muted">${c.name_en||''}</span></div>
            <div class="small muted">${c.id||''}</div>
          </div>
          <div class="small muted">${summary(c)}</div>
        `;
        row.addEventListener('click', () => selectByFilteredIndex(i));
        list.appendChild(row);
      });
      byId('count').textContent = `è¡¨ç¤º ${filtered.length} / å…¨ä½“ ${cards.length}`;
    }

    function summary(c){
      if (c.card_type === 'Pokemon') return [c.stage, c.hp?`HP${c.hp}`:'', (c.types||[]).join('/')].filter(Boolean).join(' Â· ');
      if (c.card_type === 'Energy') return c.energy_type || 'Energy';
      if (c.card_type === 'Trainer') return c.trainer_type || '';
      return '';
    }

    function selectByFilteredIndex(fi){
      const card = filtered[fi];
      const absoluteIndex = cards.findIndex(c => c === card);
      if (absoluteIndex === -1) return;
      activeIndex = absoluteIndex;
      writeForm(cards[activeIndex]);
      updatePreview();
      renderList();
    }

    // --------- ãƒ•ã‚©ãƒ¼ãƒ  <-> ãƒ‡ãƒ¼ã‚¿
    function writeForm(card){
      const c = card || defaultCard();
      byId('id').value = c.id || '';
      byId('card_type').value = c.card_type || 'Pokemon';
      byId('name_en').value = c.name_en || '';
      byId('name_ja').value = c.name_ja || '';

      // Pokemon
      byId('stage').value = c.stage || '';
      byId('hp').value = c.hp ?? '';
      byId('evolves_from').value = c.evolves_from || '';
      byId('evolves_to').value = (c.evolves_to||[]).join(',');
      byId('types').value = (c.types||[]).join(',');
      byId('rule_box').value = c.rule_box || '';
      byId('weakness').value = (c.weakness||[]).map(w=>`${w.type}:${w.value}`).join('; ');
      byId('resistance').value = c.resistance? `${c.resistance.type}:${c.resistance.value}` : '';
      byId('retreat_cost').value = c.retreat_cost ?? '';
      byId('ability_name').value = c.ability?.name_ja || '';
      byId('ability_text').value = [c.ability?.text_ja||'', c.ability?.text_en||''].filter((x,i)=>x&&(i<2)).join(' / ');
      writeAttacksToForm(c.attacks);

      // Energy
      byId('energy_type').value = c.energy_type || '';
      byId('energy_effect').value = [c.effect_ja||'', c.effect_en||''].filter((x,i)=>x&&(i<2)).join(' / ');
      byId('energy_rules').value = [c.rules_ja||'', c.rules_en||''].filter((x,i)=>x&&(i<2)).join(' / ');

      // Trainer
      byId('trainer_type').value = c.trainer_type || '';
      byId('trainer_text').value = [c.text_ja||'', c.text_en||''].filter((x,i)=>x&&(i<2)).join(' / ');

      // Image
      byId('image_file').value = c.image_file || '';
      updateImageActions();

      onTypeChange();
      setStatus('ç·¨é›†: ' + (c.id || '(æ–°è¦)'));
      updatePreview();
    }

    function readForm(){
      return schemaGuard({});
    }

    function onTypeChange(){
      const t = byId('card_type').value;
      byId('pokemonFields').style.display = (t==='Pokemon') ? '' : 'none';
      byId('energyFields').style.display  = (t==='Energy') ? '' : 'none';
      byId('trainerFields').style.display = (t==='Trainer') ? '' : 'none';
    }

    // --------- CRUD
    function newCard(){
      const c = defaultCard();
      c.id = generateNextId(); // è‡ªå‹•IDç”Ÿæˆ
      activeIndex = cards.push(c) - 1;
      writeForm(c);
      renderList();
      updatePreview();
      markUnsaved(true);
      setStatus(`æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ (ID: ${c.id}) ã‚’ä½œæˆã—ã¾ã—ãŸã€‚æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ã€Œmasterä¿å­˜ã€ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
      // æ–°è¦ä½œæˆæ™‚ã¯åå‰å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
      setTimeout(() => {
        const nameInput = byId('name_en');
        if (nameInput) nameInput.focus();
      }, 100);
    }

    /**
     * ç¾åœ¨ç·¨é›†ä¸­ã®ã‚«ãƒ¼ãƒ‰ã‚’ãƒªã‚¹ãƒˆã«ä¿å­˜
     * data-manager.jsã®æ­£è¦åŒ–ãƒ­ã‚¸ãƒƒã‚¯ã¨çµ±ä¸€
     */
    function saveCurrentIntoList(){
      const rawData = readForm();
      
      // ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–ã‚’é©ç”¨
      const data = normalizeCardForEditor(rawData);
      
      // åŸºæœ¬å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯
      if (!data || !data.id || !data.name_en || !data.name_ja || !data.card_type){
        alert('âŒ å¿…é ˆé …ç›®ãŒæœªå…¥åŠ›ã§ã™:\nâ€¢ ID\nâ€¢ è‹±èªå (name_en)\nâ€¢ æ—¥æœ¬èªå (name_ja)\nâ€¢ ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥ (card_type)');
        return false;
      }
      
      // IDã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãŸã‚é‡è¤‡ãƒã‚§ãƒƒã‚¯ä¸è¦ï¼ˆå¿µã®ãŸã‚è­¦å‘Šã®ã¿ï¼‰
      const dup = cards.findIndex((c, i) => c.id === data.id && i !== activeIndex);
      if (dup !== -1){
        console.warn(`âš ï¸ IDé‡è¤‡æ¤œå‡ºï¼ˆé€šå¸¸ç™ºç”Ÿã—ãªã„ï¼‰: ${data.id}`);
      }
      
      // ã‚«ãƒ¼ãƒ‰ç¨®åˆ¥åˆ¥ã®è©³ç´°ãƒã‚§ãƒƒã‚¯
      const validationErrors = validateCardData(data);
      if (validationErrors.length > 0) {
        const errorMsg = 'âŒ ä»¥ä¸‹ã®é …ç›®ã«å•é¡ŒãŒã‚ã‚Šã¾ã™:\n\n' + validationErrors.join('\n');
        alert(errorMsg);
        return false;
      }
      
      // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã¨è‹±èªåã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆè­¦å‘Šã®ã¿ï¼‰
      const imageWarnings = checkImageConsistency(data);
      if (imageWarnings.length > 0) {
        const proceed = confirm(
          'âš ï¸ ç”»åƒã«é–¢ã™ã‚‹è­¦å‘ŠãŒã‚ã‚Šã¾ã™:\n\n' + 
          imageWarnings.join('\n') + 
          '\n\nãã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ'
        );
        if (!proceed) return false;
      }
      
      if (activeIndex === -1){
        activeIndex = cards.push(data) - 1;
      } else {
        cards[activeIndex] = data;
      }
      setStatus(`âœ… ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜: ${data.name_en} (ID: ${data.id}) [${data.card_type}]`);
      renderList();
      updatePreview();
      markUnsaved(false);
      return true;
    }

    /**
     * ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ç”¨ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æ­£è¦åŒ–
     * data-manager.jsã®æ­£è¦åŒ–ãƒ­ã‚¸ãƒƒã‚¯ã¨çµ±ä¸€
     */
    function normalizeCardForEditor(card) {
      const normalized = { ...card };
      
      // === IDæ­£è¦åŒ– ===
      if (!normalized.id || normalized.id.trim() === '') {
        normalized.id = generateNextId();
      } else {
        // 3æ¡ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°å½¢å¼ã«æ­£è¦åŒ–
        const numericId = parseInt(normalized.id, 10);
        if (!isNaN(numericId) && numericId > 0) {
          normalized.id = String(numericId).padStart(3, '0');
        }
      }
      
      // === ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—æ­£è¦åŒ– ===
      if (normalized.card_type === 'Pokemon') {
        normalized.card_type = 'PokÃ©mon';
      }
      
      // === ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰çµ±ä¸€ ===
      if (!normalized.image_file && normalized.image) {
        normalized.image_file = normalized.image;
        delete normalized.image;
      }
      
      // ç©ºã®ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      if (normalized.image_file === '' || normalized.image_file === null) {
        delete normalized.image_file;
      }
      
      // === ã‚¹ãƒ†ãƒ¼ã‚¸æ­£è¦åŒ– ===
      if (normalized.stage === 'Basic') normalized.stage = 'BASIC';
      if (normalized.stage === 'Stage1') normalized.stage = 'STAGE1';
      if (normalized.stage === 'Stage2') normalized.stage = 'STAGE2';
      
      // === å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è­¦å‘Š ===
      const warnings = [];
      if (!normalized.name_en) warnings.push('è‹±èªåãŒæœªè¨­å®š');
      if (!normalized.name_ja) warnings.push('æ—¥æœ¬èªåãŒæœªè¨­å®š');
      
      if (warnings.length > 0) {
        console.warn(`âš ï¸ Card warnings for ID ${normalized.id}:`, warnings);
      }
      
      return normalized;
    }
    
    function validateCardData(data) {
      const errors = [];
      
      if (data.card_type === 'Pokemon') {
        // ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ã®å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (!data.stage) {
          errors.push('â€¢ ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰: ã‚¹ãƒ†ãƒ¼ã‚¸ãŒæœªè¨­å®š');
        }
        if (!data.hp || data.hp <= 0) {
          errors.push('â€¢ ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰: HPãŒæœªè¨­å®šã¾ãŸã¯0ä»¥ä¸‹');
        }
        if (!data.types || data.types.length === 0) {
          errors.push('â€¢ ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰: ã‚¿ã‚¤ãƒ—ãŒæœªè¨­å®š');
        }
        if (data.retreat_cost === undefined || data.retreat_cost < 0) {
          errors.push('â€¢ ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰: ã«ã’ã‚‹ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒæœªè¨­å®š');
        }
        // æ”»æ’ƒãŒ1ã¤ã‚‚è¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆ
        if (!data.attacks || data.attacks.length === 0) {
          errors.push('â€¢ ãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰: æ”»æ’ƒãŒ1ã¤ã‚‚è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        } else {
          // æ”»æ’ƒã®å†…å®¹ãƒã‚§ãƒƒã‚¯
          data.attacks.forEach((attack, idx) => {
            if (!attack.name_ja && !attack.name_en) {
              errors.push(`â€¢ æ”»æ’ƒ${idx + 1}: æŠ€åãŒæœªè¨­å®š`);
            }
            if (!attack.cost || attack.cost.length === 0) {
              errors.push(`â€¢ æ”»æ’ƒ${idx + 1}: ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚³ã‚¹ãƒˆãŒæœªè¨­å®š`);
            }
          });
        }
      } else if (data.card_type === 'Energy') {
        // ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒ¼ãƒ‰ã®å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (!data.energy_type) {
          errors.push('â€¢ ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒ¼ãƒ‰: ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚¿ã‚¤ãƒ—ãŒæœªè¨­å®š');
        }
      } else if (data.card_type === 'Trainer') {
        // ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚«ãƒ¼ãƒ‰ã®å¿…é ˆãƒã‚§ãƒƒã‚¯
        if (!data.trainer_type) {
          errors.push('â€¢ ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚«ãƒ¼ãƒ‰: ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚¿ã‚¤ãƒ—ãŒæœªè¨­å®š');
        }
        if (!data.text_ja && !data.text_en) {
          errors.push('â€¢ ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚«ãƒ¼ãƒ‰: åŠ¹æœãƒ†ã‚­ã‚¹ãƒˆãŒæœªè¨­å®š');
        }
      }
      
      return errors;
    }
    
    function checkImageConsistency(data) {
      const warnings = [];
      const imageFile = data.image_file || '';
      
      if (!imageFile) {
        warnings.push('â€¢ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return warnings;
      }
      
      // ç”»åƒæ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯
      const extMatch = imageFile.toLowerCase().match(/\.[^.]+$/);
      const ext = extMatch ? extMatch[0] : '';
      const allowedExts = ['.webp', '.jpg', '.jpeg', '.png'];
      if (!allowedExts.includes(ext)) {
        warnings.push('â€¢ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å½¢å¼ã§ã™ (å¯¾å¿œ: .webp/.jpg/.jpeg/.png)');
      }
      
      // è‹±èªåã¨ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒã‚±ãƒ¢ãƒ³ã‚«ãƒ¼ãƒ‰ã®å ´åˆï¼‰
      if (data.card_type === 'Pokemon' && data.name_en) {
        const expectedFileName = data.name_en.replace(/[^A-Za-z0-9]+/g, '_') + ext;
        const fileNameWithoutExt = imageFile.replace(/\.[^.]+$/, '');
        const nameEnNormalized = data.name_en.replace(/[^A-Za-z0-9]+/g, '_');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åã¨è‹±èªåãŒå¤§ããç•°ãªã‚‹å ´åˆ
        if (!fileNameWithoutExt.toLowerCase().includes(nameEnNormalized.toLowerCase()) && 
            !nameEnNormalized.toLowerCase().includes(fileNameWithoutExt.toLowerCase())) {
          warnings.push(`â€¢ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã€Œ${imageFile}ã€ã¨è‹±èªåã€Œ${data.name_en}ã€ãŒä¸€è‡´ã—ã¾ã›ã‚“\n  æ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«å: ${expectedFileName}`);
        }
      }
      
      // ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒ¼ãƒ‰ã®å ´åˆã®å‘½åãƒã‚§ãƒƒã‚¯
      if (data.card_type === 'Energy' && data.energy_type) {
        const expectedFileName = `Energy_${data.energy_type}${ext}`;
        if (imageFile !== expectedFileName) {
          warnings.push(`â€¢ ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚«ãƒ¼ãƒ‰ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åãŒæ¨™æº–ã¨ç•°ãªã‚Šã¾ã™\n  æ¨å¥¨ãƒ•ã‚¡ã‚¤ãƒ«å: ${expectedFileName}`);
        }
      }
      
      return warnings;
    }

    function duplicateCard(){
      if (activeIndex < 0) return;
      const src = JSON.parse(JSON.stringify(cards[activeIndex]));
      const originalName = src.name_ja || src.name_en || src.id;
      src.id = generateNextId(); // è‡ªå‹•IDç”Ÿæˆ
      cards.splice(activeIndex+1, 0, src);
      activeIndex = activeIndex+1;
      writeForm(src);
      renderList();
      updatePreview();
      markUnsaved(true);
      setStatus(`ã€Œ${originalName}ã€ã‚’è¤‡è£½ã—ã¾ã—ãŸ (æ–°ID: ${src.id})ã€‚å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã—ã¦ãã ã•ã„ã€‚`);
    }

    function deleteCard(){
      if (activeIndex < 0) return;
      const c = cards[activeIndex];
      if (!confirm(`å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n${c.id} ${c.name_ja}`)) return;
      cards.splice(activeIndex, 1);
      activeIndex = -1;
      writeForm(defaultCard());
      renderList();
      updatePreview();
      markUnsaved(true);
    }

    // --------- èª­ã¿è¾¼ã¿/ä¿å­˜ï¼ˆã‚·ãƒ³ãƒ—ãƒ«åŒ–ï¼‰

    function normalizeToSpec(arr){
      if (!Array.isArray(arr)) return [];
      return arr.map(c => {
        const out = { ...c };
        // card_type normalize
        if (out.card_type === 'PokÃ©mon') out.card_type = 'Pokemon';
        if (typeof out.card_type === 'string' && out.card_type.includes('Energy')) out.card_type = 'Energy';
        // type -> types
        if (!out.types && out.type) { out.types = [String(out.type)]; delete out.type; }
        // weakness object -> array
        if (out.weakness && !Array.isArray(out.weakness)) { out.weakness = [out.weakness]; }
        // retreat_cost array -> number
        if (Array.isArray(out.retreat_cost)) { out.retreat_cost = out.retreat_cost.length; }
        // stage uppercase -> proper
        if (out.stage === 'BASIC') out.stage = 'Basic';
        if (out.stage === 'STAGE1') out.stage = 'Stage1';
        if (out.stage === 'STAGE2') out.stage = 'Stage2';
        // ability effect_* -> text_*
        if (out.ability && (out.ability.effect_en || out.ability.effect_ja)) {
          out.ability = {
            name_en: out.ability.name_en || '',
            name_ja: out.ability.name_ja || '',
            text_en: out.ability.effect_en || out.ability.text_en || '',
            text_ja: out.ability.effect_ja || out.ability.text_ja || ''
          };
        }
        // attacks effect_* -> text_*
        if (Array.isArray(out.attacks)){
          out.attacks = out.attacks.map(a => ({
            name_en: a.name_en || '',
            name_ja: a.name_ja || '',
            cost: Array.isArray(a.cost) ? a.cost : [],
            damage: (a.damage === 0 || a.damage) ? Number(a.damage) : undefined,
            text_en: a.effect_en || a.text_en || undefined,
            text_ja: a.effect_ja || a.text_ja || undefined,
          }));
        }
        // image -> image_file
        if (!out.image_file && out.image) out.image_file = out.image;
        return out;
      });
    }

    async function openMaster(){
      // 1) ã¾ãš fetch ã§ãƒ­ãƒ¼ã‚«ãƒ«åŒæ¢±ã‚’è©¦ã™
      try {
        const res = await fetch('data/cards-master.json', { cache: 'no-cache' });
        if (res.ok){
          cards = normalizeToSpec(await res.json());
          if (cards.length > 0) {
            activeIndex = 0;
            writeForm(cards[0]);
          } else {
            activeIndex = -1;
            writeForm(defaultCard());
          }
          renderList();
          setStatus('ãƒ­ãƒ¼ã‚«ãƒ«åŒæ¢±ã® master ã‚’èª­è¾¼');
          updatePreview();
          return;
        }
      } catch {}

      // 2) ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã§èª­ã¿è¾¼ã¿
      try {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          const text = await file.text();
          cards = normalizeToSpec(JSON.parse(text));
          if (!Array.isArray(cards)) cards = [];
          if (cards.length > 0) {
            activeIndex = 0;
            writeForm(cards[0]);
          } else {
            activeIndex = -1;
            writeForm(defaultCard());
          }
          renderList();
          setStatus('master ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
          updatePreview();
        };
        input.click();
      } catch (e) {
        console.error(e);
        alert('master ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function findDuplicateIds() {
      const idCounts = {};
      const duplicates = [];
      
      cards.forEach(card => {
        if (card.id) {
          idCounts[card.id] = (idCounts[card.id] || 0) + 1;
        }
      });
      
      for (const [id, count] of Object.entries(idCounts)) {
        if (count > 1) {
          duplicates.push(`ID "${id}" ãŒ ${count} å›ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™`);
        }
      }
      
      return duplicates;
    }

    async function processAndSaveImages() {
      // Current card's image processing
      const fileInput = byId('image_upload');
      if (fileInput.files && fileInput.files.length > 0) {
        setStatus('ç”»åƒã‚’.webpã«å¤‰æ›ä¸­...');
        try {
          await saveImageAsWebP(fileInput.files[0]);
          // Clear the file input after successful save
          fileInput.value = '';
          const statusDiv = byId('image-upload-status');
          statusDiv.textContent = 'âœ… ç”»åƒãŒ.webpã«å¤‰æ›ã•ã‚Œä¿å­˜ã•ã‚Œã¾ã—ãŸ';
          statusDiv.style.color = 'var(--ok)';
        } catch (error) {
          console.error('Image save failed:', error);
          // ã‚¨ãƒ©ãƒ¼ãŒã€Œç½®ãæ›ãˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if (error.message === 'ç”»åƒã®ç½®ãæ›ãˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ') {
            console.log('ç”»åƒã®ç½®ãæ›ãˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
            return; // ã‚¨ãƒ©ãƒ¼ã‚’æŠ•ã’ãšã«ã‚¹ã‚­ãƒƒãƒ—
          }
          throw new Error(`ç”»åƒã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
        }
      }
    }

    async function saveImageAsWebP(file) {
      const cardType = (byId('card_type').value || 'Pokemon').toLowerCase();
      const cardId = byId('id').value.trim();
      const nameEn = byId('name_en').value.trim();
      
      // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ç¨®é¡ã‚’ãƒã‚§ãƒƒã‚¯
      const isAlreadyWebP = file.type === 'image/webp' || file.name.toLowerCase().endsWith('.webp');
      
      // æ—¢å­˜ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯å‰Šé™¤ç¢ºèª
      const currentCard = cards[activeIndex];
      const oldFileName = currentCard?.image_file;
      let shouldDeleteOld = false;
      
      if (oldFileName) {
        // è‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã‚‹æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…ˆã«è¨ˆç®—
        let newFileName;
        if (cardType === 'energy') {
          const energyType = byId('energy_type').value.trim();
          newFileName = energyType ? `${cardId}_Energy_${energyType}.webp` : `${cardId}.webp`;
        } else {
          const safeName = nameEn ? nameEn.replace(/[^A-Za-z0-9\-]+/g, '_') : 'Card';
          newFileName = `${cardId}_${cardType}_${safeName}.webp`;
        }
        
        // å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«åã¨æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åãŒåŒã˜å ´åˆã¯å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (oldFileName === newFileName && isAlreadyWebP) {
          console.log(`æ—¢å­˜ã®WebPãƒ•ã‚¡ã‚¤ãƒ«ã¨åŒåã®ãŸã‚å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—: ${oldFileName}`);
          return { filename: oldFileName, path: `assets/cards/${cardType}/${oldFileName}` };
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«åãŒç•°ãªã‚‹ã‹ã€WebPä»¥å¤–ã‹ã‚‰ã®å¤‰æ›ã®å ´åˆã¯å‰Šé™¤ç¢ºèª
        shouldDeleteOld = confirm(
          `æ—¢å­˜ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${oldFileName}ã€ã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ç”»åƒã«ç½®ãæ›ãˆã¾ã™ã‹ï¼Ÿ\n\n` +
          `æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«å: ${newFileName}\n\n` +
          'ã€Œã¯ã„ã€: å¤ã„ç”»åƒã‚’å‰Šé™¤ã—ã¦æ–°ã—ã„ç”»åƒã‚’ä¿å­˜\n' +
          'ã€Œã„ã„ãˆã€: ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
        );
        if (!shouldDeleteOld) {
          throw new Error('ç”»åƒã®ç½®ãæ›ãˆãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        }
      }
      
      // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å†è¨ˆç®—ï¼ˆä¸Šã§è¨ˆç®—æ¸ˆã¿ã®å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ï¼‰
      let fileName;
      if (cardType === 'energy') {
        const energyType = byId('energy_type').value.trim();
        fileName = energyType ? `${cardId}_Energy_${energyType}.webp` : `${cardId}.webp`;
      } else {
        // IDã¨ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã—ã¦æ¨™æº–çš„ãªå‘½å
        const safeName = nameEn ? nameEn.replace(/[^A-Za-z0-9\-]+/g, '_') : 'Card';
        fileName = `${cardId}_${cardType}_${safeName}.webp`;
      }
      
      // UIã«æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
      byId('image_file').value = fileName;
      
      // æ—¢ã«WebPã®å ´åˆã¯ç›´æ¥ä¿å­˜ã€ãã†ã§ãªã‘ã‚Œã°Canvaså¤‰æ›
      return new Promise((resolve, reject) => {
        const processAndSave = async (blob) => {
          try {
            // Try CardAPI first
            if (window.CardAPI && window.CardAPI.uploadImage) {
              // å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«å‰Šé™¤
              if (shouldDeleteOld && oldFileName && oldFileName !== fileName) {
                try {
                  if (window.CardAPI.deleteImage) {
                    await window.CardAPI.deleteImage(oldFileName);
                    console.log(`å‰Šé™¤ã•ã‚ŒãŸå¤ã„ç”»åƒãƒ•ã‚¡ã‚¤ãƒ« (API): ${oldFileName}`);
                  }
                } catch (deleteError) {
                  console.warn(`å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•— (API): ${oldFileName}`, deleteError);
                }
              }
              
              const result = await window.CardAPI.uploadImage(blob, {
                filename: fileName,
                cardType: cardType,
                cardId: cardId
              });
              
              if (result && result.path) {
                const currentCard = cards[activeIndex];
                if (currentCard) {
                  currentCard.image_file = result.filename || fileName;
                  currentCard.image_url = result.path;
                }
                updatePreview();
                resolve(result);
              } else {
                reject(new Error('API upload failed: CardAPI.uploadImage did not return a valid path.'));
              }
              return; // APIã‚’ä½¿ã£ãŸå ´åˆã¯ã“ã“ã§å‡¦ç†ã‚’çµ‚äº†
            }
            
            // Fallback to file system API
            if ('showDirectoryPicker' in window) {
              const dirHandle = await window.showDirectoryPicker();
              const assetsHandle = await dirHandle.getDirectoryHandle('assets', { create: true });
              const cardsHandle = await assetsHandle.getDirectoryHandle('cards', { create: true });
              const typeHandle = await cardsHandle.getDirectoryHandle(cardType, { create: true });
              
              // å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
              if (shouldDeleteOld && oldFileName && oldFileName !== fileName) {
                try {
                  await typeHandle.removeEntry(oldFileName);
                  console.log(`å‰Šé™¤ã•ã‚ŒãŸå¤ã„ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«: ${oldFileName}`);
                } catch (deleteError) {
                  console.warn(`å¤ã„ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—: ${oldFileName}`, deleteError);
                  // å‰Šé™¤ã«å¤±æ•—ã—ã¦ã‚‚å‡¦ç†ã‚’ç¶šè¡Œ
                }
              }
              
              const fileHandle = await typeHandle.getFileHandle(fileName, { create: true });
              const writable = await fileHandle.createWritable();
              await writable.write(blob);
              await writable.close();
              
              const currentCard = cards[activeIndex];
              if (currentCard) {
                currentCard.image_file = fileName;
              }
              updatePreview();
              resolve({ filename: fileName, path: `assets/cards/${cardType}/${fileName}` });
            } else {
              reject(new Error('File system API not supported'));
            }
          } catch (error) {
            reject(error);
          }
        };

        // æ—¢ã«WebPãƒ•ã‚¡ã‚¤ãƒ«ã®å ´åˆã¯ç›´æ¥ä¿å­˜
        if (isAlreadyWebP) {
          console.log('æ—¢ã«WebPãƒ•ã‚¡ã‚¤ãƒ«ã®ãŸã‚ç›´æ¥ä¿å­˜ã—ã¾ã™');
          processAndSave(file);
        } else {
          // WebPä»¥å¤–ã®å ´åˆã¯Canvaså¤‰æ›
          console.log('WebPã«å¤‰æ›ä¸­...');
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const img = new Image();
          
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            
            canvas.toBlob((blob) => {
              if (!blob) {
                return reject(new Error('Canvas to Blob conversion failed. The image might be empty or too large.'));
              }
              processAndSave(blob);
            }, 'image/webp', 0.9);
          };
          
          img.onerror = () => reject(new Error('Image load failed'));
          img.src = URL.createObjectURL(file);
        }
      });
    }

    async function saveMaster(){
      if (!saveCurrentIntoList()) return;
      
      // Process any pending image uploads with WebP conversion
      await processAndSaveImages();
      
      // Check for ID-based duplicates before saving
      const duplicateIds = findDuplicateIds();
      if (duplicateIds.length > 0) {
        const proceed = confirm(
          'âš ï¸ é‡è¤‡IDãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:\n\n' + 
          duplicateIds.join('\n') + 
          '\n\nãã®ã¾ã¾ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ'
        );
        if (!proceed) return;
      }
      
      const json = JSON.stringify(cards, null, 2);
      try {
        const res = await fetch('data/cards-master.json', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=utf-8' },
          body: json
        });
        if (!res.ok) throw new Error('save failed');
        setStatus('master ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        markUnsaved(false);
      } catch (e) {
        console.error(e);
        alert('master ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }



    // --------- åˆæœŸåŒ–
    function bind(){
      byId('filterType').addEventListener('change', renderList);
      byId('search').addEventListener('input', renderList);
      byId('btn-new').addEventListener('click', newCard);
      byId('btn-new-card').addEventListener('click', newCard);
      byId('btn-duplicate').addEventListener('click', duplicateCard);
      byId('btn-delete').addEventListener('click', deleteCard);
      byId('btn-save-master').addEventListener('click', saveMaster);
      byId('btn-open-master').addEventListener('click', openMaster);
      byId('btn-fix-extensions').addEventListener('click', fixAllExtensions);
      byId('btn-back-to-game').addEventListener('click', () => {
        if (unsaved && !confirm('æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ã‚²ãƒ¼ãƒ ã«æˆ»ã‚Šã¾ã™ã‹ï¼Ÿ')) return;
        window.location.href = 'index.html';
      });
      byId('card_type').addEventListener('change', () => { onTypeChange(); updatePreview(); markUnsaved(true); });
      byId('btn-add-attack').addEventListener('click', () => {
        byId('attacks').appendChild(createAttackBox());
      });

      // Drawer controls
      byId('btn-open-drawer').addEventListener('click', openDrawer);
      byId('btn-close-drawer').addEventListener('click', closeDrawer);
      byId('drawer-backdrop').addEventListener('click', closeDrawer);

      // Preview controls
      byId('btn-prev').addEventListener('click', goPrev);
      byId('btn-next').addEventListener('click', goNext);
      byId('image_upload').addEventListener('change', () => { 
        // ç”»åƒé¸æŠæ™‚ã«ä¸€æ™‚çš„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆä¿å­˜ã¯è¡Œã‚ãªã„ï¼‰
        const input = byId('image_upload');
        if (input.files && input.files[0]) {
          const currentFileName = byId('image_file').value.trim();
          if (!currentFileName) {
            const guessedName = guessImageFile();
            if (guessedName) {
              byId('image_file').value = guessedName;
            }
          }
          
          // ä¸€æ™‚çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºã®çŠ¶æ…‹ã‚’ç¤ºã™
          const statusDiv = byId('image-upload-status');
          statusDiv.textContent = 'ğŸ“· ä¸€æ™‚ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ - ã‚«ãƒ¼ãƒ‰ã‚’ä¿å­˜ã§.webpã«å¤‰æ›ã•ã‚Œã¾ã™';
          statusDiv.style.display = 'block';
          statusDiv.style.color = 'var(--warn)';
          updateImageActions();
        }
        updatePreview(); 
        markUnsaved(true); 
      });
      byId('btn-pick-image').addEventListener('click', openImagePicker);
      byId('btn-gallery').addEventListener('click', openImageGallery);
      byId('btn-optimize-image').addEventListener('click', optimizeCurrentImage);
      byId('btn-delete-image').addEventListener('click', deleteCurrentImage);
      byId('zoom').addEventListener('input', (e) => { zoomLevel = Number(e.target.value); applyTransform(); });
      byId('btn-zoom-in').addEventListener('click', () => { zoomLevel = Math.min(3, (zoomLevel + 0.1)); byId('zoom').value = zoomLevel.toFixed(1); applyTransform(); });
      byId('btn-zoom-out').addEventListener('click', () => { zoomLevel = Math.max(0.5, (zoomLevel - 0.1)); byId('zoom').value = zoomLevel.toFixed(1); applyTransform(); });
      byId('btn-fit').addEventListener('click', () => { zoomLevel = 1; pan = {x:0,y:0}; byId('zoom').value = '1'; applyTransform(); });
      byId('btn-actual').addEventListener('click', () => { zoomLevel = 1.5; pan = {x:0,y:0}; byId('zoom').value = String(zoomLevel); applyTransform(); });

      const stage = byId('preview-stage');
      stage.addEventListener('wheel', (e) => {
        if (!e.ctrlKey) return;
        e.preventDefault();
        const delta = Math.sign(e.deltaY) * -0.1;
        zoomLevel = Math.min(3, Math.max(0.5, zoomLevel + delta));
        byId('zoom').value = zoomLevel.toFixed(1);
        applyTransform();
      }, { passive: false });
      stage.addEventListener('mousedown', (e) => { isPanning = true; panStart = { x: e.clientX, y: e.clientY }; lastPan = { ...pan }; });
      window.addEventListener('mousemove', (e) => { if (!isPanning) return; const dx = e.clientX - panStart.x; const dy = e.clientY - panStart.y; pan = { x: lastPan.x + dx, y: lastPan.y + dy }; applyTransform(); });
      window.addEventListener('mouseup', () => { isPanning = false; });

      // Form change detection
      $$('#cardForm input, #cardForm select, #cardForm textarea').forEach(el => {
        el.addEventListener('input', () => { markUnsaved(true); if (el.id.startsWith('image')) updatePreview(); });
        el.addEventListener('change', () => { markUnsaved(true); if (el.id.startsWith('image')) updatePreview(); });
      });

      // Keyboard shortcuts
      window.addEventListener('keydown', (e) => {
        if (e.key === 'k' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); openDrawer(); byId('search').focus(); }
        if (e.key === 's' && (e.ctrlKey || e.metaKey) && e.shiftKey) { e.preventDefault(); saveCurrentCardAsFile(); }
        else if (e.key === 's' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); saveMaster(); }
        if (e.key === 'n' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); newCard(); }
        if (e.key === 'ArrowDown') { e.preventDefault(); goNext(); }
        if (e.key === 'ArrowUp') { e.preventDefault(); goPrev(); }
        if (e.key === 'Escape' && isDrawerOpen()) { closeDrawer(); }
      });

      // Warn on unload if unsaved
      window.addEventListener('beforeunload', (e) => { if (unsaved){ e.preventDefault(); e.returnValue = ''; } });
    }


    async function boot(){
      bind();
      adjustLayout();
      window.addEventListener('resize', adjustLayout);
      // æ—¢å­˜ã® data/cards-master.json ã‚’ fetch ã—ã€å¯èƒ½ãªã‚‰æœ€åˆã«è¡¨ç¤º
      try {
        const res = await fetch('data/cards-master.json', { cache: 'no-cache' });
        if (res.ok) {
          const raw = await res.json();
          cards = normalizeToSpec(raw);
          activeIndex = cards.length ? 0 : -1;
          renderList();
          writeForm(cards[activeIndex] || defaultCard());
          setStatus('ãƒ­ãƒ¼ã‚«ãƒ«åŒæ¢±ã® master ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
          updatePreview();
          return;
        }
      } catch {}
      cards = [];
      renderList();
      writeForm(defaultCard());
      setStatus('æ–°è¦ä½œæˆã‚’é–‹å§‹ã§ãã¾ã™ã€‚masterèª­è¾¼ãƒœã‚¿ãƒ³ã§JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã§ãã¾ã™ã€‚');
      updatePreview();
    }

    document.addEventListener('DOMContentLoaded', boot);

    // ---------- Drawer helpers
    function openDrawer(){ byId('drawer').classList.add('open'); }
    function closeDrawer(){ byId('drawer').classList.remove('open'); }
    function isDrawerOpen(){ return byId('drawer').classList.contains('open'); }

    // ---------- Layout helper
    function adjustLayout(){
      const header = document.querySelector('header');
      const container = document.querySelector('.container');
      if (!header || !container) return;
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®å®Ÿéš›ã®é«˜ã•ã‚’å–å¾—ã—ã¦ã€ã‚³ãƒ³ãƒ†ãƒŠé«˜ã‚’èª¿æ•´
      const h = header.getBoundingClientRect().height;
      container.style.height = `${window.innerHeight - h}px`;
      
      // ç”»é¢ã‚µã‚¤ã‚ºã«å¿œã˜ãŸå¾®èª¿æ•´ï¼ˆãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒªã¨åˆã‚ã›ã‚‹ï¼‰
      if (window.innerWidth <= 599) {
        container.style.height = `${window.innerHeight - h}px`;
      } else if (window.innerWidth <= 767) {
        container.style.height = `${window.innerHeight - h}px`;
      }
    }

    // ---------- Preview helpers
    function getImageExtension() {
      const name = (byId('image_file').value || '').trim().toLowerCase();
      const match = name.match(/\.[^.]+$/);
      return match ? match[0] : '.webp';
    }
    function currentPreviewUrl(){
      // 1) Uploaded
      const input = byId('image_upload');
      if (input.files && input.files[0]) return URL.createObjectURL(input.files[0]);
      const t = (byId('card_type').value || 'Pokemon').toLowerCase();
      
      // 2) Explicit filename with extension fallback
      const fileName = (byId('image_file').value || '').trim();
      if (fileName) {
        return getImageUrlWithFallback(`assets/cards/${t}/${fileName}`);
      }
      
      const ext = getImageExtension();
      // 3) Auto-map for Energy
      if (t === 'energy'){
        const et = (byId('energy_type').value || '').trim();
        if (et) return getImageUrlWithFallback(`assets/cards/energy/Energy_${et}${ext}`);
      }
      // 4) Heuristic for Pokemon from English name
      if (t === 'pokemon'){
        const en = (byId('name_en').value || '').trim();
        if (en){
          const guess = en.replace(/[^A-Za-z0-9]+/g, '_') + ext;
          return getImageUrlWithFallback(`assets/cards/pokemon/${guess}`);
        }
      }
      // 5) No image
      return '';
    }

    function getImageUrlWithFallback(basePath) {
      // æ‹¡å¼µå­å€™è£œãƒªã‚¹ãƒˆï¼ˆå„ªå…ˆé †ä½é †ï¼‰
      const extensions = ['.webp', '.jpg', '.jpeg', '.png'];
      const pathWithoutExt = basePath.replace(/\.[^.]+$/, '');
      const currentExt = basePath.match(/\.[^.]+$/)?.[0] || '';
      
      // å…ƒã®æ‹¡å¼µå­ãŒå«ã¾ã‚Œã¦ã„ãªã„å ´åˆã¯è¿½åŠ 
      if (currentExt && !extensions.includes(currentExt.toLowerCase())) {
        extensions.unshift(currentExt);
      }
      
      // å…ƒã®ãƒ‘ã‚¹ãŒæ‹¡å¼µå­ã‚’æŒã¤å ´åˆã€ãã‚Œã‚’æœ€å„ªå…ˆã«ã™ã‚‹
      if (currentExt) {
        const filteredExts = extensions.filter(ext => ext !== currentExt);
        return basePath; // ã¾ãšå…ƒã®ãƒ‘ã‚¹ã‚’è©¦è¡Œï¼ˆ404æ™‚ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¯img.onerrorã§å‡¦ç†ï¼‰
      }
      
      // æ‹¡å¼µå­ãŒãªã„å ´åˆã¯.webpã‚’å„ªå…ˆ
      return pathWithoutExt + '.webp';
    }

    // 404ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦åŒã˜ã‚¨ãƒ©ãƒ¼ã‚’ç¹°ã‚Šè¿”ã•ãªã„
    const failedUrls = new Set();
    
    function tryExtensionFallback(imgElement, originalUrl, onAllFailed) {
      // æ—¢ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ä¸­ã®å ´åˆã¯é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
      if (imgElement.dataset.fallbackInProgress === 'true') {
        return;
      }
      
      // æ—¢ã«å¤±æ•—ã—ãŸURLã®å ´åˆã¯å³åº§ã«å¤±æ•—ã¨ã—ã¦å‡¦ç†
      if (failedUrls.has(originalUrl)) {
        onAllFailed();
        return;
      }
      
      imgElement.dataset.fallbackInProgress = 'true';
      
      const extensions = ['.webp', '.jpg', '.jpeg', '.png'];
      const pathWithoutExt = originalUrl.replace(/\.[^.]+$/, '');
      const currentExt = originalUrl.match(/\.[^.]+$/)?.[0] || '';
      
      // ç¾åœ¨ã®æ‹¡å¼µå­ä»¥å¤–ã®å€™è£œã‚’å–å¾—
      const fallbackExtensions = extensions.filter(ext => ext !== currentExt.toLowerCase());
      
      let attemptIndex = 0;
      
      function tryNextExtension() {
        if (attemptIndex >= fallbackExtensions.length) {
          // å…¨ã¦ã®æ‹¡å¼µå­ã§å¤±æ•—ã—ãŸå ´åˆ
          imgElement.dataset.fallbackInProgress = 'false';
          failedUrls.add(originalUrl); // å¤±æ•—ã—ãŸURLã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
          onAllFailed();
          return;
        }
        
        const nextUrl = pathWithoutExt + fallbackExtensions[attemptIndex];
        attemptIndex++;
        
        // æ—¢ã«å¤±æ•—ã—ãŸURLã¯ã‚¹ã‚­ãƒƒãƒ—
        if (failedUrls.has(nextUrl)) {
          tryNextExtension();
          return;
        }
        
        // æ–°ã—ã„ç”»åƒè¦ç´ ã‚’ä½œæˆã—ã¦ãƒ†ã‚¹ãƒˆ
        const testImg = new Image();
        
        testImg.onload = () => {
          // æˆåŠŸã—ãŸå ´åˆã€ãƒ¡ã‚¤ãƒ³ã®ç”»åƒè¦ç´ ã‚’æ›´æ–°
          imgElement.src = nextUrl;
          imgElement.dataset.fallbackInProgress = 'false';
          
          // å¯¾å¿œã™ã‚‹æ‹¡å¼µå­ã§ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ›´æ–°
          const newExtension = fallbackExtensions[attemptIndex - 1];
          const currentFileName = byId('image_file').value.trim();
          if (currentFileName && currentFileName.includes('.')) {
            const newFileName = currentFileName.replace(/\.[^.]+$/, '') + newExtension;
            if (newFileName !== currentFileName) {
              byId('image_file').value = newFileName;
              markUnsaved(true);
              console.log(`ç”»åƒæ‹¡å¼µå­ã‚’è‡ªå‹•ä¿®æ­£: ${currentFileName} â†’ ${newFileName}`);
            }
          }
        };
        
        testImg.onerror = () => {
          // ã“ã®æ‹¡å¼µå­ã§å¤±æ•—ã—ãŸå ´åˆã€å¤±æ•—URLã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¦æ¬¡ã‚’è©¦è¡Œ
          failedUrls.add(nextUrl);
          tryNextExtension();
        };
        
        testImg.src = nextUrl;
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é–‹å§‹
      tryNextExtension();
    }
    function updatePreview(){
      const url = currentPreviewUrl();
      const img = byId('preview-img');
      const empty = byId('preview-empty');
      const deleteBtn = byId('btn-delete-image');
      
      if (!url){ 
        img.removeAttribute('src'); 
        empty.style.display = 'block'; 
        deleteBtn.style.display = 'none';
        return; 
      }
      
      img.src = url;
      img.onerror = () => {
        // æ—¢ã«ã‚¨ãƒ©ãƒ¼å‡¦ç†ä¸­ã®å ´åˆã¯é‡è¤‡å®Ÿè¡Œã‚’é˜²ã
        if (img.dataset.errorHandled === 'true') return;
        img.dataset.errorHandled = 'true';
        
        // æ‹¡å¼µå­ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è©¦è¡Œ
        tryExtensionFallback(img, url, () => {
          // å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¤±æ•—ã—ãŸå ´åˆ
          img.onerror = null;
          img.src = 'assets/ui/card_back.webp';
          empty.textContent = 'ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åã¾ãŸã¯ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚¿ã‚¤ãƒ—ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚';
          empty.style.display = 'block';
          deleteBtn.style.display = 'none';
          console.warn(`Image not found for all extensions: ${url}`);
        });
      };
      img.onload = () => { 
        empty.style.display = 'none'; 
        updateImageActions();
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ•ãƒ©ã‚°ã‚’ã‚¯ãƒªã‚¢
        img.dataset.errorHandled = 'false';
      };
      applyTransform();
      // Reflect current filename into the input (if using assets path)
      try {
        const used = (new URL(url, location.href)).pathname;
        if (used.includes('/assets/cards/')){
          const name = used.split('/').pop();
          if (name && name !== 'card_back.webp'){
            const input = byId('image_file');
            if (input && input.value.trim() !== name) input.value = name;
          }
        }
      } catch {}
    }
    function applyTransform(){
      const img = byId('preview-img');
      img.style.transform = `translate(${pan.x}px, ${pan.y}px) scale(${zoomLevel})`;
    }
    // ---------- Image helpers
    function guessImageFile(){
      const cardType = (byId('card_type').value || 'Pokemon').toLowerCase();
      const cardId = (byId('id').value || '').trim();
      const nameEn = (byId('name_en').value || '').trim();
      const ext = getImageExtension();

      if (!cardId) return ''; // IDãŒå¿…é ˆ

      if (cardType === 'energy'){
        const energyType = (byId('energy_type').value || '').trim();
        return energyType ? `${cardId}_Energy_${energyType}${ext}` : `${cardId}${ext}`;
      }

      if (cardType === 'pokemon' || cardType === 'trainer'){
        if (!nameEn) return `${cardId}${ext}`; // åå‰ãŒãªã„å ´åˆã¯IDã®ã¿

        // ç‰¹åˆ¥ãªåå‰ã®ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ãƒã‚§ãƒƒã‚¯
        const specialNames = {
          "Glasswing Butterfly Larva": "Glasswing_Butterfly_Larva",
          "Cat exv": "Cat_exv",
          "Grey Dagger Moth Larva": "Grey_Dagger_Moth_Larva",
          // Update mapping to reflect hyphenated asset filename
          "Short-horned Grasshopper": "Short-horned_Grasshopper",
          "Tateha Butterfly": "Tateha_Butterfly",
          "Caterpillar exz": "Caterpillar_exz",
          "Taiwan Clouded Yellow": "Taiwan_Clouded_Yellow",
          "Kurohime Crane Fly": "Kurohime_Crane_Fly",
          "Bee ex": "Bee_ex",
          "Hosohari Stinkbug ex": "Hosohari_Stinkbug_ex",
          "Tonosama Grasshopper": "Tonosama_Grasshopper",
          "Rainbow Skink": "Rainbow_Skink",
          "Longhorn Beetle": "Longhorn_Beetle",
          "Tsumamurasaki Madara": "Tsumamurasaki_Madara",
          "Kobane Inago": "Kobane_Inago",
          "Orange Spider": "Orange_Spider"
        };
        
        const fileName = specialNames[nameEn] || nameEn.replace(/[^A-Za-z0-9]+/g, '_');
        return `${cardId}_${fileName}${ext}`;
      }

      return `${cardId}${ext}`;
    }
    function updateImageActions() {
      const filename = byId('image_file').value.trim();
      const imageActionsDiv = byId('image-actions');
      const statusDiv = byId('image-upload-status');
      const optimizeBtn = byId('btn-optimize-image');
      
      if (filename) {
        // ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
        imageActionsDiv.style.display = 'block';
        
        // æœ€é©åŒ–ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
        const isOptimizable = !filename.toLowerCase().endsWith('.webp');
        optimizeBtn.style.display = isOptimizable ? 'inline-block' : 'none';
        
        // çŠ¶æ³è¡¨ç¤º
        if (statusDiv.style.display === 'none') {
          statusDiv.textContent = `ğŸ“ ${filename}`;
          statusDiv.style.color = 'var(--text-secondary)';
          statusDiv.style.display = 'block';
        }
      } else {
        // ç”»åƒãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆ
        imageActionsDiv.style.display = 'none';
        statusDiv.style.display = 'none';
      }
    }

    function openImagePicker(){
      // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
      const input = byId('image_upload');
      input.click();
    }
    // ---------- Modal
    function openModal(html){ const panel = byId('modal-panel'); const modal = byId('modal'); if (!panel||!modal) return; panel.innerHTML = html; modal.classList.remove('invisible'); const mb = byId('modal-backdrop'); if (mb) mb.onclick = closeModal; }
    function closeModal(){ const modal = byId('modal'); if (modal) modal.classList.add('invisible'); }

    // ---------- Image Gallery
    async function openImageGallery() {
      try {
        const response = await CardAPI.getAllImages();
        const images = response.images || [];
        
        const html = `
          <div style="max-height: 70vh; overflow-y: auto;">
            <h2 style="margin: 0 0 16px 0; color: var(--text); font-size: 20px;">ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ (${images.length}ä»¶)</h2>
            
            <!-- Search and Filter Controls -->
            <div style="margin-bottom: 16px; display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
              <input type="text" id="gallery-search" placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åã§æ¤œç´¢..." style="
                flex: 1; min-width: 200px; padding: 6px 10px; border: 1px solid var(--border); 
                border-radius: 6px; background: var(--bg-secondary); color: var(--text);
              " />
              <select id="gallery-filter-type" style="
                padding: 6px 10px; border: 1px solid var(--border); 
                border-radius: 6px; background: var(--bg-secondary); color: var(--text);
              ">
                <option value="">å…¨ã‚¿ã‚¤ãƒ—</option>
                <option value="energy">Energy</option>
                <option value="pokemon">Pokemon</option>
                <option value="trainer">Trainer</option>
                <option value="legacy">Legacy</option>
              </select>
              <select id="gallery-filter-ext" style="
                padding: 6px 10px; border: 1px solid var(--border); 
                border-radius: 6px; background: var(--bg-secondary); color: var(--text);
              ">
                <option value="">å…¨æ‹¡å¼µå­</option>
                <option value=".webp">.webp</option>
                <option value=".jpg">.jpg</option>
                <option value=".jpeg">.jpeg</option>
                <option value=".png">.png</option>
              </select>
              <select id="gallery-sort" style="
                padding: 6px 10px; border: 1px solid var(--border); 
                border-radius: 6px; background: var(--bg-secondary); color: var(--text);
              ">
                <option value="name">åå‰é †</option>
                <option value="size">ã‚µã‚¤ã‚ºé †</option>
                <option value="date">æ›´æ–°æ—¥é †</option>
              </select>
            </div>
            
            <div id="gallery-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
              ${images.map(img => `
                <div class="gallery-item" data-filename="${img.filename}" style="
                  border: 2px solid var(--border); 
                  border-radius: 8px; 
                  overflow: hidden; 
                  cursor: pointer; 
                  transition: all 0.2s;
                  background: var(--bg-secondary);
                ">
                  <img src="${img.path}" alt="${img.filename}" style="
                    width: 100%; 
                    height: 120px; 
                    object-fit: cover; 
                    display: block;
                  " />
                  <div style="padding: 6px; text-align: center;">
                    <div style="font-size: 11px; color: var(--text-secondary); word-break: break-all;">
                      ${img.filename}
                    </div>
                    <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 2px;">
                      ${(img.size / 1024).toFixed(1)}KB
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
            <div style="margin-top: 16px; text-align: right;">
              <button onclick="closeModal()" class="btn">é–‰ã˜ã‚‹</button>
              <button onclick="showUnusedImages()" class="btn" style="margin-left: 8px;">æœªä½¿ç”¨ç”»åƒ</button>
            </div>
          </div>
        `;
        
        openModal(html);
        
        // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
        let filteredImages = [...images];
        
        function updateGalleryDisplay() {
          const searchTerm = byId('gallery-search').value.toLowerCase();
          const extFilter = byId('gallery-filter-ext').value;
          const sortBy = byId('gallery-sort').value;
          
          // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          filteredImages = images.filter(img => {
            const matchesSearch = img.filename.toLowerCase().includes(searchTerm);
            const matchesExt = !extFilter || img.filename.toLowerCase().endsWith(extFilter);
            return matchesSearch && matchesExt;
          });
          
          // ã‚½ãƒ¼ãƒˆ
          filteredImages.sort((a, b) => {
            switch(sortBy) {
              case 'name':
                return a.filename.localeCompare(b.filename);
              case 'size':
                return b.size - a.size; // å¤§ãã„é †
              case 'date':
                return new Date(b.modified) - new Date(a.modified); // æ–°ã—ã„é †
              default:
                return 0;
            }
          });
          
          // è¡¨ç¤ºæ›´æ–°
          const grid = byId('gallery-grid');
          grid.innerHTML = filteredImages.map(img => `
            <div class="gallery-item" data-filename="${img.filename}" style="
              border: 2px solid var(--border); 
              border-radius: 8px; 
              overflow: hidden; 
              cursor: pointer; 
              transition: all 0.2s;
              background: var(--bg-secondary);
            ">
              <img src="${img.path}" alt="${img.filename}" style="
                width: 100%; 
                height: 120px; 
                object-fit: cover; 
                display: block;
              " />
              <div style="padding: 6px; text-align: center;">
                <div style="font-size: 11px; color: var(--text-secondary); word-break: break-all;">
                  ${img.filename}
                </div>
                <div style="font-size: 10px; color: var(--text-tertiary); margin-top: 2px;">
                  ${(img.size / 1024).toFixed(1)}KB
                </div>
              </div>
            </div>
          `).join('');
          
          // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å†è¿½åŠ 
          attachGalleryEvents();
          
          // ä»¶æ•°è¡¨ç¤ºæ›´æ–°
          const title = document.querySelector('h2');
          title.textContent = `ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ (${filteredImages.length}/${images.length}ä»¶)`;
        }
        
        function attachGalleryEvents() {
          document.querySelectorAll('.gallery-item').forEach(item => {
            item.addEventListener('click', () => {
              const filename = item.dataset.filename;
              byId('image_file').value = filename;
              updateImageActions();
              updatePreview();
              markUnsaved(true);
              closeModal();
            });
            
            // ãƒ›ãƒãƒ¼åŠ¹æœ
            item.addEventListener('mouseenter', () => {
              item.style.borderColor = 'var(--primary)';
              item.style.transform = 'scale(1.05)';
            });
            item.addEventListener('mouseleave', () => {
              item.style.borderColor = 'var(--border)';
              item.style.transform = 'scale(1)';
            });
          });
        }
        
        // åˆæœŸè¡¨ç¤ºã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
        attachGalleryEvents();
        
        // æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã‚¤ãƒ™ãƒ³ãƒˆ
        byId('gallery-search').addEventListener('input', updateGalleryDisplay);
        byId('gallery-filter-ext').addEventListener('change', updateGalleryDisplay);
        byId('gallery-sort').addEventListener('change', updateGalleryDisplay);
        
      } catch (error) {
        console.error('Failed to load image gallery:', error);
        alert('ç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function showUnusedImages() {
      try {
        const response = await CardAPI.getUnusedImages();
        const unused = response.unused || [];
        
        if (unused.length === 0) {
          alert('æœªä½¿ç”¨ã®ç”»åƒã¯ã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const html = `
          <div style="max-height: 70vh; overflow-y: auto;">
            <h2 style="margin: 0 0 16px 0; color: var(--text); font-size: 20px;">æœªä½¿ç”¨ç”»åƒ (${unused.length}ä»¶)</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 12px;">
              ${unused.map(filename => `
                <div class="unused-item" data-filename="${filename}" style="
                  border: 2px solid #ff6b6b; 
                  border-radius: 8px; 
                  overflow: hidden; 
                  background: var(--bg-secondary);
                  position: relative;
                ">
                  <img src="/assets/cards/${filename}" alt="${filename}" style="
                    width: 100%; 
                    height: 120px; 
                    object-fit: cover; 
                    display: block;
                    opacity: 0.7;
                  " />
                  <div style="padding: 6px; text-align: center;">
                    <div style="font-size: 11px; color: var(--text-secondary); word-break: break-all;">
                      ${filename}
                    </div>
                    <button onclick="deleteUnusedImage('${filename}')" class="btn btn-danger" style="font-size: 10px; padding: 2px 6px; margin-top: 4px;">å‰Šé™¤</button>
                  </div>
                </div>
              `).join('')}
            </div>
            <div style="margin-top: 16px; text-align: right;">
              <button onclick="closeModal()" class="btn">é–‰ã˜ã‚‹</button>
            </div>
          </div>
        `;
        
        openModal(html);
        
      } catch (error) {
        console.error('Failed to load unused images:', error);
        alert('æœªä½¿ç”¨ç”»åƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function deleteUnusedImage(filename) {
      if (!confirm(`ç”»åƒã€Œ${filename}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
      
      try {
        await CardAPI.deleteImage(filename);
        showUnusedImages(); // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
      } catch (error) {
        console.error('Failed to delete image:', error);
        alert('ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    async function deleteCurrentImage() {
      const filename = byId('image_file').value.trim();
      if (!filename) {
        alert('å‰Šé™¤ã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      if (!confirm(`ç”»åƒã€Œ${filename}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) return;
      
      try {
        await CardAPI.deleteImage(filename);
        byId('image_file').value = '';
        updateImageActions();
        updatePreview();
        markUnsaved(true);
        alert('ç”»åƒã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('Failed to delete image:', error);
        alert('ç”»åƒã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ---------- Extension Consistency Fixes
    async function fixAllExtensions() {
      if (!confirm('ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã®ç”»åƒæ‹¡å¼µå­ã‚’å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ç…§åˆã—ã¦ä¿®æ­£ã—ã¾ã™ã‹ï¼Ÿ')) return;
      
      try {
        const response = await CardAPI.getAllImages();
        const availableImages = response.images || [];
        const imageMap = new Map();
        
        // åˆ©ç”¨å¯èƒ½ãªç”»åƒã‚’ãƒãƒƒãƒ—ã«ç™»éŒ²ï¼ˆæ‹¡å¼µå­ãªã—ã®ãƒ™ãƒ¼ã‚¹åã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼‰
        availableImages.forEach(img => {
          const baseName = img.filename.replace(/\.[^.]+$/, '').toLowerCase();
          if (!imageMap.has(baseName)) {
            imageMap.set(baseName, []);
          }
          imageMap.get(baseName).push(img.filename);
        });
        
        let fixedCount = 0;
        cards.forEach(card => {
          if (card.image_file) {
            const baseName = card.image_file.replace(/\.[^.]+$/, '').toLowerCase();
            const availableFiles = imageMap.get(baseName);
            
            if (availableFiles && availableFiles.length > 0) {
              // å„ªå…ˆé †ä½: .webp > .jpg > .jpeg > .png
              const preferredOrder = ['.webp', '.jpg', '.jpeg', '.png'];
              let bestMatch = availableFiles[0];
              
              for (const ext of preferredOrder) {
                const candidate = availableFiles.find(f => f.toLowerCase().endsWith(ext));
                if (candidate) {
                  bestMatch = candidate;
                  break;
                }
              }
              
              if (bestMatch !== card.image_file) {
                console.log(`æ‹¡å¼µå­ä¿®æ­£: ${card.image_file} â†’ ${bestMatch} (${card.name_en || card.id})`);
                card.image_file = bestMatch;
                fixedCount++;
              }
            }
          }
        });
        
        if (fixedCount > 0) {
          markUnsaved(true);
          updatePreview();
          renderList();
          alert(`${fixedCount}å€‹ã®ã‚«ãƒ¼ãƒ‰ã®æ‹¡å¼µå­ã‚’ä¿®æ­£ã—ã¾ã—ãŸã€‚ã€Œmasterä¿å­˜ã€ã§ç¢ºå®šã—ã¦ãã ã•ã„ã€‚`);
        } else {
          alert('ä¿®æ­£ãŒå¿…è¦ãªæ‹¡å¼µå­ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        }
        
      } catch (error) {
        console.error('Extension fix failed:', error);
        alert('æ‹¡å¼µå­ä¿®æ­£ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ---------- Image Optimization
    async function optimizeCurrentImage() {
      const filename = byId('image_file').value.trim();
      if (!filename) {
        alert('æœ€é©åŒ–ã™ã‚‹ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«åãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      if (filename.toLowerCase().endsWith('.webp')) {
        alert('ã“ã®ç”»åƒã¯æ—¢ã«WebPå½¢å¼ã§æœ€é©åŒ–ã•ã‚Œã¦ã„ã¾ã™');
        return;
      }
      
      if (!confirm(`ç”»åƒã€Œ${filename}ã€ã‚’WebPå½¢å¼ã«æœ€é©åŒ–ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      try {
        const cardType = (byId('card_type').value || 'Pokemon').toLowerCase();
        const currentUrl = currentPreviewUrl();
        
        if (!currentUrl || currentUrl.startsWith('blob:')) {
          alert('æœ€é©åŒ–å¯èƒ½ãªç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // ç¾åœ¨è¡¨ç¤ºä¸­ã®ç”»åƒã‚’å–å¾—
        const img = byId('preview-img');
        if (!img.src || !img.complete) {
          alert('ç”»åƒã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“');
          return;
        }
        
        // Canvas ã§ WebP ã«å¤‰æ›
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // æœ€å¤§ã‚µã‚¤ã‚ºåˆ¶é™
        const maxWidth = 800;
        const maxHeight = 1200;
        let { width, height } = img;
        
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = Math.floor(width * ratio);
          height = Math.floor(height * ratio);
        }
        
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);
        
        // WebP ã¨ã—ã¦æ›¸ãå‡ºã—
        const webpDataUrl = canvas.toDataURL('image/webp', 0.85);
        const blob = await (await fetch(webpDataUrl)).blob();
        
        // æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
        const webpFilename = filename.replace(/\.[^.]+$/, '.webp');
        
        // File System API ã§ä¿å­˜ã‚’è©¦è¡Œ
        if ('showDirectoryPicker' in window) {
          const dirHandle = await window.showDirectoryPicker();
          const assetsHandle = await dirHandle.getDirectoryHandle('assets', { create: true });
          const cardsHandle = await assetsHandle.getDirectoryHandle('cards', { create: true });
          const typeHandle = await cardsHandle.getDirectoryHandle(cardType, { create: true });
          
          const fileHandle = await typeHandle.getFileHandle(webpFilename, { create: true });
          const writable = await fileHandle.createWritable();
          await writable.write(blob);
          await writable.close();
          
          // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æ›´æ–°
          byId('image_file').value = webpFilename;
          updateImageActions();
          updatePreview();
          markUnsaved(true);
          
          alert(`ç”»åƒã‚’WebPã«æœ€é©åŒ–ã—ã¾ã—ãŸ: ${filename} â†’ ${webpFilename}\nã‚µã‚¤ã‚º: ${(blob.size/1024).toFixed(1)}KB`);
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã‚’ä½œæˆ
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = webpFilename;
          a.style.display = 'none';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          alert(`WebPå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ: ${webpFilename}\næ‰‹å‹•ã§assetsãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã—ã¦ãã ã•ã„`);
        }
        
      } catch (error) {
        console.error('Failed to optimize image:', error);
        alert('ç”»åƒã®æœ€é©åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    function guessNameFromCard(card){
      const t = (card.card_type||'Pokemon').toLowerCase();
      const extMatch = (card.image_file || '').toLowerCase().match(/\.[^.]+$/);
      const ext = extMatch ? extMatch[0] : '.webp';
      if (t==='energy' && card.energy_type) return `Energy_${card.energy_type}${ext}`;
      if (t==='pokemon' && card.name_en) return card.name_en.replace(/[^A-Za-z0-9]+/g,'_')+ext;
      return '';
    }
    function goNext(){
      if (cards.length === 0) return;
      const nextIdx = (activeIndex + 1) % cards.length;
      activeIndex = nextIdx;
      writeForm(cards[activeIndex]);
      updatePreview();
      renderList();
    }
    function goPrev(){
      if (cards.length === 0) return;
      const prevIdx = (activeIndex - 1 + cards.length) % cards.length;
      activeIndex = prevIdx;
      writeForm(cards[activeIndex]);
      updatePreview();
      renderList();
    }
  </script>
  <!-- Card editor server integration -->
  <script src="./js/card-api.js"></script>
  <script src="./js/card-viewer-integration.js"></script>
</body>
</html>
